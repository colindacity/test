<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negotiation Wins - Interactive Widget</title>
    <!-- 
    CORS FIX: This application automatically detects when running from file:// protocol
    and uses embedded data instead of trying to load external CSV files to avoid CORS errors.
    For production use, serve this file from a web server (http/https) to enable CSV file loading.
    -->
    <style>
        /* Base Variables for Webflow Inheritance */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Roboto:wght@300;400;500;700;900&family=Montserrat:wght@300;400;500;600;700;800;900&family=Open+Sans:wght@300;400;600;700;800&family=Lato:wght@300;400;700;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #5E5ADB;
            --secondary-color: #FF6B6B;
            --success-color: #4ECDC4;
            --accent-color: #9C27B0;
            --text-primary: #1A1A2E;
            --text-secondary: #6C757D;
            --bg-light: #F8F9FA;
            --bg-white: #FFFFFF;
            --font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --base-font-size: 16px;
            --card-padding: 24px;
            --card-gap: 20px;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
            --border-radius: 12px;
            --animation-duration: 200s;
        }

        /* Base Reset & Typography - Inherits from Webflow */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            background: var(--bg-light);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            /* Chrome Extension Compatibility */
            isolation: auto;
            contain: none;
        }

        /* Container Styles */
        .wins-container {
            width: calc(100vw - 350px); /* Account for sidebar */
            padding: 60px 0;
            background: var(--bg-white);
            position: relative;
            overflow: hidden;
            min-height: 100vh;
        }

        .section-header {
            text-align: center;
            margin-bottom: 50px;
            padding: 0 20px;
        }

        .section-title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }

        .section-title:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(94, 90, 219, 0.1);
            -webkit-text-fill-color: var(--text-primary);
        }

        .section-subtitle {
            font-size: clamp(1rem, 2vw, 1.25rem);
            color: var(--text-secondary);
            font-weight: 400;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }

        .section-subtitle:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(94, 90, 219, 0.1);
        }

        /* Infinite Scroll Wrapper */
        .infinite-scroll-wrapper {
            width: 100%;
            overflow: hidden;
            position: relative;
            margin: 40px 0;
        }

        .infinite-scroll-wrapper::before,
        .infinite-scroll-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            width: 100px;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .infinite-scroll-wrapper::before {
            left: 0;
            background: linear-gradient(90deg, var(--bg-white) 0%, transparent 100%);
        }

        .infinite-scroll-wrapper::after {
            right: 0;
            background: linear-gradient(90deg, transparent 0%, var(--bg-white) 100%);
        }

        .infinite-scroll-track {
            display: flex;
            width: fit-content;
            animation: scroll var(--animation-duration) linear infinite;
        }

        .infinite-scroll-content {
            display: flex;
            gap: var(--card-gap);
            padding: 10px;
            flex-shrink: 0;
        }

        @keyframes scroll {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-33.3333%);
            }
        }

        /* Pause on Hover */
        .infinite-scroll-wrapper:hover .infinite-scroll-track {
            animation-play-state: paused;
        }

        /* ==================== DESIGN 1: CARD STYLE ==================== */
        .win-card {
            min-width: 320px;
            padding: var(--card-padding);
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: calc(var(--border-radius) * 1.5);
            box-shadow: 
                0 8px 32px rgba(31, 38, 135, 0.15),
                inset 0 1px 2px rgba(255,255,255,0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            overflow: hidden;
        }

        .win-card::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: var(--border-radius);
            padding: 2px;
            background: var(--gradient-1);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .win-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .win-card:hover::before {
            opacity: 1;
        }

        .card-company {
            font-size: calc(var(--base-font-size) * 1.5);
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .card-stage {
            font-size: calc(var(--base-font-size) * 1.5);
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .card-increase {
            font-size: calc(var(--base-font-size) * 2.5);
            font-weight: 800;
            color: var(--success-color);
            margin-bottom: 4px;
        }

        .card-amount {
            font-size: calc(var(--base-font-size) * 2.5);
            font-weight: 800;
            color: var(--success-color);
            margin-bottom: 4px;
        }

        .card-amount.secondary {
            font-size: calc(var(--base-font-size) * 1.125);
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .card-increase.secondary {
            font-size: calc(var(--base-font-size) * 1.125);
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .card-details {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .card-badge {
            padding: 4px 12px;
            background: var(--bg-light);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* ==================== DESIGN 2: PILL STYLE ==================== */
        .win-pill {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 20px 28px;
            background: var(--bg-white);
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            min-width: 280px;
            max-width: 350px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid var(--bg-light);
            position: relative;
            overflow: hidden;
        }

        .win-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .win-pill:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .win-pill:hover::before {
            opacity: 1;
        }

        .pill-logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.25rem;
            padding: 8px;
        }
        
        .pill-logo svg {
            width: 100%;
            height: 100%;
            color: white;
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            padding: 12px;
        }
        
        .card-icon svg {
            width: 100%;
            height: 100%;
            color: white;
        }

        .pill-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pill-company {
            font-weight: 700;
            font-size: calc(var(--base-font-size) * 1.125);
            color: var(--text-primary);
        }

        .pill-stage {
            font-weight: 700;
            font-size: calc(var(--base-font-size) * 1.125);
            color: var(--text-primary);
        }

        .pill-stats {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pill-increase {
            font-weight: 800;
            font-size: calc(var(--base-font-size) * 1.5);
            background: var(--gradient-4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pill-amount {
            font-weight: 800;
            font-size: calc(var(--base-font-size) * 1.5);
            background: var(--gradient-4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pill-increase.secondary {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: var(--base-font-size);
        }

        .pill-amount.secondary {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: var(--base-font-size);
        }

        .pill-role {
            padding: 2px 8px;
            background: var(--bg-light);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* ==================== DESIGN 2B: PILL COMPACT STYLE ==================== */
        .win-pill-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg-white);
            border-radius: 25px;
            box-shadow: var(--shadow-sm);
            min-width: fit-content;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--bg-light);
        }
        .win-pill-compact:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        .pill-compact-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        .pill-compact-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .pill-compact-company {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .pill-compact-stage {
            font-size: 0.7rem;
            color: var(--primary-color);
            text-transform: uppercase;
            font-weight: 600;
        }
        .pill-compact-values {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .pill-compact-amount {
            color: var(--success-color);
        }
        .pill-compact-increase {
            color: var(--primary-color);
        }
        .pill-compact-role {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-left: auto;
        }
        
        /* ==================== DESIGN 2C: PILL MINIMAL STYLE ==================== */
        .win-pill-minimal {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-light);
            border-radius: 20px;
            border: 2px solid var(--primary-color);
            min-width: fit-content;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        .win-pill-minimal:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        .pill-minimal-header {
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 0.8rem;
        }
        .pill-minimal-company {
            font-weight: 600;
            color: var(--primary-color);
        }
        .pill-minimal-stage {
            color: var(--text-secondary);
            font-size: 0.7rem;
            text-transform: uppercase;
        }
        .pill-minimal-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success-color);
        }
        
        .pill-minimal-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-align: center;
        }
        
        /* ==================== DESIGN 2D: PILL CARD STYLE ==================== */
        .win-pill-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            min-width: 220px;
            max-width: 280px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid var(--bg-light);
            position: relative;
        }
        .win-pill-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }
        .pill-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .pill-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }
        .pill-card-info {
            flex: 1;
            min-width: 0;
        }
        .pill-card-company {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .pill-card-stage {
            font-size: 0.7rem;
            color: var(--primary-color);
            text-transform: uppercase;
            font-weight: 600;
        }
        .pill-card-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pill-card-main {
            text-align: center;
        }
        .pill-card-amount {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--success-color);
        }
        .pill-card-increase {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        .pill-card-secondary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .pill-card-percent {
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        .pill-card-money {
            font-size: 0.85rem;
            color: var(--success-color);
            font-weight: 600;
        }
        .pill-card-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
        }
        
        /* ==================== DESIGN 2E: PILL BADGE STYLE ==================== */
        .win-pill-badge {
            display: inline-flex;
            flex-direction: column;
            gap: 6px;
            padding: 14px 20px;
            background: var(--bg-light);
            border-radius: 30px;
            border: 2px solid var(--primary-color);
            min-width: 160px;
            max-width: 220px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-align: center;
        }
        .win-pill-badge:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-lg);
            background: var(--bg-white);
        }
        .pill-badge-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        .pill-badge-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        .pill-badge-company {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .pill-badge-stage {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .pill-badge-role {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* ==================== DESIGN 3: BANNER STYLE ==================== */
        .win-banner {
            min-width: 400px;
            padding: 32px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .win-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: var(--gradient-1);
            opacity: 0.1;
            transform: rotate(45deg);
            transition: transform 0.5s ease;
        }

        .win-banner:hover::before {
            transform: rotate(45deg) scale(1.2);
        }

        .win-banner:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .banner-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .banner-company-group {
            flex: 1;
        }

        .banner-company {
            font-size: calc(var(--base-font-size) * 2);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .banner-stage {
            font-size: calc(var(--base-font-size) * 2);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .banner-role {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .banner-increase-group {
            text-align: right;
        }

        .banner-increase {
            font-size: calc(var(--base-font-size) * 3);
            font-weight: 900;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .banner-amount {
            font-size: calc(var(--base-font-size) * 3);
            font-weight: 900;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .banner-increase-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: 4px;
        }

        .banner-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .banner-amount.secondary {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .banner-increase.secondary {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .banner-seniority {
            padding: 8px 16px;
            background: var(--gradient-3);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .win-card {
                min-width: 280px;
            }
            
            .win-banner {
                min-width: 320px;
            }
            
            .banner-company {
                font-size: 1.5rem;
            }
            
            .banner-increase {
                font-size: 2rem;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: var(--bg-white);
            border-left: 2px solid var(--primary-color);
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
            display: block;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .close-sidebar {
            display: none; /* Hide close button since sidebar is always open */
        }

        .sidebar-content {
            padding: 20px;
        }
        
        /* Color Palette Styles */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 12px 0;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }
        
        .color-swatch.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(56, 152, 236, 0.2);
        }
        
        .color-swatch[data-transparent="true"]::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd),
                        linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd);
            background-size: 8px 8px;
            background-position: 0 0, 4px 4px;
            border-radius: 6px;
            z-index: -1;
        }
        
        /* Style Presets */
        .style-presets {
            margin: 16px 0;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .preset-button {
            padding: 12px;
            background: var(--bg-light);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .preset-button:hover {
            border-color: var(--primary-color);
            background: var(--bg-white);
        }
        
        .preset-name {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .preset-preview {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 4px;
        }
        
        .preset-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .control-panel h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .control-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--bg-light);
        }

        .control-group:last-child {
            border-bottom: none;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--bg-light);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-light);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-light);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px 5px 5px 0;
        }

        .button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .button.secondary {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .button.secondary:hover {
            background: var(--text-secondary);
            color: white;
        }
        
        .button.small {
            padding: 4px 8px;
            font-size: 0.75rem;
            margin: 2px;
        }
        
        .bulk-edit-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }
        
        .bulk-edit-section label {
            margin-right: 8px;
            white-space: nowrap;
        }

        /* Data Editor Styles */
        .data-editor {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 20px;
            z-index: 1000;
            max-width: 80vw;
            max-height: 80vh;
            overflow: auto;
            border: 2px solid var(--success-color);
            display: none;
        }

        .data-editor.active {
            display: block;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-light);
        }

        .editor-title {
            color: var(--success-color);
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

        .close-editor {
            background: var(--secondary-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            border-right: 1px solid #dadce0;
            border-bottom: 1px solid #dadce0;
            padding: 8px 12px;
            text-align: left;
            min-width: 120px;
            position: relative;
        }

        .data-table th {
            background: #f8f9fa;
            color: #3c4043;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            border-right: none;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table td {
            background: white;
        }

        .data-table td input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 0.9rem;
            color: #3c4043;
            outline: none;
            margin: -4px -8px;
            min-height: 20px;
        }

        .data-table td input:focus {
            background: #e8f0fe;
            border-radius: 2px;
        }

        .data-table td input:hover {
            background: #f1f3f4;
        }

        /* Cell selection styles */
        .selected-cell {
            background: #1a73e8 !important;
            color: white !important;
            box-shadow: inset 0 0 0 2px #1a73e8;
        }

        /* Per-row override styles */
        .override-active {
            background-color: #e8f5e8 !important;
            border: 2px solid #4caf50 !important;
            position: relative;
        }

        .override-active::after {
            content: "✓";
            position: absolute;
            top: -2px;
            right: -2px;
            background: #4caf50;
            color: white;
            font-size: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .global-default {
            opacity: 0.4;
            position: relative;
        }

        .global-default::after {
            content: "🌐";
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 8px;
            opacity: 0.6;
        }

        /* Ensure checkboxes are visible */
        input[type="checkbox"] {
            width: 16px !important;
            height: 16px !important;
            appearance: checkbox !important;
            -webkit-appearance: checkbox !important;
            display: inline-block !important;
            margin: 0 !important;
            padding: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Display options styling */
        .control-group label {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            margin-bottom: 8px !important;
        }

        .control-group input[type="checkbox"] {
            flex-shrink: 0 !important;
        }

        .selected-cell input {
            color: white !important;
            background: transparent !important;
        }

        .selected-range {
            background: rgba(26, 115, 232, 0.1) !important;
            border: 1px solid #1a73e8 !important;
        }

        .selected-range input {
            background: transparent !important;
        }

        /* Row and column selection */
        .selected-row {
            background: rgba(26, 115, 232, 0.05) !important;
        }

        .selected-column {
            background: rgba(26, 115, 232, 0.05) !important;
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            cursor: col-resize;
        }

        .resize-handle:hover {
            background: #1a73e8;
        }

        /* Bulk paste indicator */
        .paste-indicator {
            position: absolute;
            background: #34a853;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            pointer-events: none;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .editor-help {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.875rem;
        }
        
        .editor-help p {
            margin: 0 0 8px 0;
            color: #3c4043;
        }
        
        .editor-help ul {
            margin: 0;
            padding-left: 20px;
            color: #5f6368;
        }
        
        .editor-help li {
            margin-bottom: 4px;
        }

        /* Sortable columns */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: #f1f3f4;
        }

        .sort-indicator {
            font-size: 0.75rem;
            margin-left: 4px;
            opacity: 0.6;
        }

        .sortable.sorted-asc .sort-indicator::after {
            content: " ↑";
            opacity: 1;
        }

        .sortable.sorted-desc .sort-indicator::after {
            content: " ↓";
            opacity: 1;
        }

        /* Overlay for modal */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Utility Classes */
        .mt-60 {
            margin-top: 60px;
        }

        .divider {
            height: 2px;
            background: var(--bg-light);
            margin: 60px auto;
            max-width: 200px;
        }

        .hidden {
            display: none !important;
        }

        /* Widget Style Pills */
        .style-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .style-pill {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--bg-light);
            border-radius: 20px;
            background: var(--bg-white);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .style-pill.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .style-pill:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .style-pill.active:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* Advanced Styling Options */
        .styling-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .styling-option {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .styling-option.full-width {
            grid-column: 1 / -1;
        }

        .styling-option label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .styling-option input,
        .styling-option select {
            padding: 6px 8px;
            border: 1px solid var(--bg-light);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .styling-option input:focus,
        .styling-option select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Number Input Styling */
        .number-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .number-input input[type="number"] {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid var(--bg-light);
            border-radius: 6px;
            text-align: center;
        }

        /* Font Family Options */
        .font-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Animation Controls */
        .animation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .animation-controls label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        /* Chrome Extension Compatibility */
        .chrome-extension-fix {
            /* Ensure elements are not isolated from extensions */
            isolation: auto;
            contain: none;
            will-change: auto;
        }

        /* Better input styling for extensions */
        input, select, textarea, button {
            -webkit-appearance: none;
            appearance: none;
            background-clip: padding-box;
        }

        /* Ensure proper stacking context */
        .widget-container {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="wins-container">
        <!-- Header -->
        <div class="section-header">
            <h1 class="section-title" id="mainTitle" contenteditable="true">Recent Negotiation Wins</h1>
            <p class="section-subtitle" id="mainSubtitle" contenteditable="true">Year 1 Compensation Increases at Top Tech Companies</p>
        </div>

        <!-- DESIGN 1: Card Style -->
        <div class="infinite-scroll-wrapper">
            <div class="infinite-scroll-track">
                <!-- Cards will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 2: Pill Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Pills will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 2B: Pill Compact Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Compact Pills will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 2C: Pill Minimal Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Minimal Pills will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 2D: Pill Card Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Card Pills will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 2E: Pill Badge Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Badge Pills will be dynamically generated -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- DESIGN 3: Banner Style -->
        <div class="infinite-scroll-wrapper mt-60">
            <div class="infinite-scroll-track" style="--animation-duration: 200s;">
                <!-- Banners will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Widget Controls</h2>
            <button class="close-sidebar" id="closeSidebar">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <!-- Widget Style Selection -->
            <div class="control-group">
                <label>Widget Styles</label>
                <div class="style-pills">
                    <div class="style-pill active" data-style="card">Card</div>
                    <div class="style-pill active" data-style="pill">Pill</div>
                    <div class="style-pill active" data-style="pill-compact">Compact</div>
                    <div class="style-pill active" data-style="pill-minimal">Minimal</div>
                    <div class="style-pill active" data-style="pill-card">Card Pills</div>
                    <div class="style-pill active" data-style="pill-badge">Badge Pills</div>
                    <div class="style-pill active" data-style="banner">Banner</div>
                </div>
            </div>

            <!-- Animation Controls -->
            <div class="control-group">
                <label>Animation</label>
                <div class="animation-controls">
                    <label>Speed:</label>
                    <div class="number-input">
                        <input type="number" id="speedInput" min="5" max="200" value="200">
                        <span>seconds</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="playPauseBtn" class="button">Pause</button>
                    <button id="resetBtn" class="button secondary">Reset</button>
                </div>
            </div>

            <!-- Color Customization -->
            <div class="control-group">
                <label>Color Palette</label>
                <div class="color-palette" id="colorPalette">
                    <!-- Color swatches will be added by JavaScript -->
                </div>
                <label>Custom Colors</label>
                <div class="styling-grid">
                    <div class="styling-option">
                        <label for="primaryColor">Primary</label>
                        <input type="color" id="primaryColor" value="#5E5ADB">
                    </div>
                    <div class="styling-option">
                        <label for="secondaryColor">Secondary</label>
                        <input type="color" id="secondaryColor" value="#FF6B6B">
                    </div>
                    <div class="styling-option">
                        <label for="successColor">Success</label>
                        <input type="color" id="successColor" value="#4ECDC4">
                    </div>
                    <div class="styling-option">
                        <label for="accentColor">Accent</label>
                        <input type="color" id="accentColor" value="#9C27B0">
                    </div>
                </div>
            </div>
            
            <!-- Style Presets -->
            <div class="control-group">
                <label>Style Presets</label>
                <div class="preset-grid" id="stylePresets">
                    <!-- Preset buttons will be added by JavaScript -->
                </div>
            </div>

            <!-- Typography -->
            <div class="control-group">
                <label>Typography</label>
                <div class="styling-grid">
                    <div class="styling-option">
                        <label for="fontFamily">Font Family</label>
                        <select id="fontFamily">
                            <option value="system">System Default</option>
                            <option value="inter">Inter</option>
                            <option value="roboto">Roboto</option>
                            <option value="opensans">Open Sans</option>
                            <option value="lato">Lato</option>
                            <option value="montserrat">Montserrat</option>
                            <option value="poppins">Poppins</option>
                        </select>
                        <div class="font-preview" id="fontPreview">Sample Text</div>
                    </div>
                    <div class="styling-option">
                        <label for="fontSize">Base Font Size</label>
                        <div class="number-input">
                            <input type="number" id="fontSize" min="12" max="24" value="16">
                            <span>px</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spacing & Layout -->
            <div class="control-group">
                <label>Spacing & Layout</label>
                <div class="styling-grid">
                    <div class="styling-option">
                        <label for="cardPadding">Card Padding</label>
                        <div class="number-input">
                            <input type="number" id="cardPadding" min="8" max="48" value="24">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="styling-option">
                        <label for="cardGap">Card Gap</label>
                        <div class="number-input">
                            <input type="number" id="cardGap" min="8" max="40" value="20">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="styling-option">
                        <label for="borderRadius">Border Radius</label>
                        <div class="number-input">
                            <input type="number" id="borderRadius" min="0" max="24" value="12">
                            <span>px</span>
                        </div>
                    </div>
                    <div class="styling-option">
                        <label for="shadowIntensity">Shadow</label>
                        <select id="shadowIntensity">
                            <option value="none">None</option>
                            <option value="light">Light</option>
                            <option value="medium" selected>Medium</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Display Options -->
            <div class="control-group">
                <label>Display Options</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                        <input type="checkbox" id="showCompany">
                        <span>Company Names</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                        <input type="checkbox" id="showStage" checked>
                        <span>Company Stage</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                        <input type="checkbox" id="showIncrease" checked>
                        <span>Percentage</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                        <input type="checkbox" id="showAmount" checked>
                        <span>Dollar Amount</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                        <input type="checkbox" id="showRole" checked>
                        <span>Role/Department</span>
                    </label>
                </div>
            </div>

            <!-- Value Priority -->
            <div class="control-group">
                <label for="valuePriority">Primary Value</label>
                <select id="valuePriority" class="control-input">
                    <option value="amount">Dollar Amount</option>
                    <option value="increase">Percentage</option>
                </select>
            </div>
            
            <!-- Number Formatting -->
            <div class="control-group">
                <label>Number Formatting</label>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: normal;">
                            <input type="checkbox" id="useShortForm" checked>
                            <span>Use short form (K) for amounts</span>
                        </label>
                    </div>
                    <div>
                        <label for="amountDecimals" style="font-weight: normal; display: block; margin-bottom: 4px;">Amount decimals:</label>
                        <select id="amountDecimals" class="control-input">
                            <option value="0">None (150K)</option>
                            <option value="1" selected>One (150.5K)</option>
                            <option value="2">Two (150.50K)</option>
                        </select>
                    </div>
                    <div>
                        <label for="percentDecimals" style="font-weight: normal; display: block; margin-bottom: 4px;">Percent decimals:</label>
                        <select id="percentDecimals" class="control-input">
                            <option value="0">None (25%)</option>
                            <option value="1">One (25.5%)</option>
                            <option value="2" selected>Two (25.50%)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="control-group">
                <label>Data Management</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button id="editDataBtn" class="button">Edit Data</button>
                    <div style="display: flex; gap: 8px;">
                        <button id="exportDataBtn" class="button secondary">Export</button>
                        <button id="importDataBtn" class="button secondary">Import</button>
                    </div>
                    <input type="file" id="importFile" accept=".json,.csv" style="display: none;">
                </div>
            </div>
            
            <!-- Copy to Webflow -->
            <div class="control-group">
                <label>Copy for Webflow</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button id="copyCardBtn" class="button">Copy Card Widget</button>
                    <button id="copyPillBtn" class="button">Copy Pill Widget</button>
                    <button id="copyPillCompactBtn" class="button">Copy Pill Compact Widget</button>
                    <button id="copyPillMinimalBtn" class="button">Copy Pill Minimal Widget</button>
                    <button id="copyPillCardBtn" class="button">Copy Pill Card Widget</button>
                    <button id="copyPillBadgeBtn" class="button">Copy Pill Badge Widget</button>
                    <button id="copyBannerBtn" class="button">Copy Banner Widget</button>
                    <button id="copyAllBtn" class="button secondary">Copy All Widgets</button>
                    <div id="copyStatus" style="display: none; padding: 8px; background: var(--success-color); color: white; border-radius: 8px; text-align: center; font-size: 0.875rem;">Copied to clipboard!</div>
                </div>
            </div>

            <!-- Theme Options -->
            <div class="control-group">
                <label for="themeSelect">Theme</label>
                <select id="themeSelect" class="control-input">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="ocean">Ocean</option>
                    <option value="sunset">Sunset</option>
                    <option value="forest">Forest</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Data Editor Modal -->
    <div class="overlay" id="editorOverlay"></div>
    <div class="data-editor" id="dataEditor">
        <div class="editor-header">
            <h3 class="editor-title">Edit Data</h3>
            <button class="close-editor" id="closeEditor">&times;</button>
        </div>
        
        <div class="editor-actions">
            <button id="addRowBtn" class="button">Add Row</button>
            <button id="hideRowBtn" class="button secondary">Hide Selected</button>
            <button id="showRowBtn" class="button secondary">Show Selected</button>
            <button id="showHiddenBtn" class="button secondary">👁 Show Hidden</button>
            <button id="reloadFullDataBtn" class="button secondary" style="background: #f59e0b;">🔄 Reload All 68 Rows</button>
            <button id="copyBtn" class="button secondary">Copy (⌘+C)</button>
            <button id="pasteBtn" class="button secondary">Paste (⌘+V)</button>
            <button id="selectAllBtn" class="button secondary">Select All (⌘+A)</button>
            <div class="bulk-edit-section" style="border-left: 2px solid #ddd; padding-left: 8px; margin-left: 8px;">
                <label style="font-size: 0.8rem; color: #666;">Bulk Edit Selected:</label>
                <button id="bulkShowCompanyBtn" class="button small">Show Company</button>
                <button id="bulkHideCompanyBtn" class="button small">Hide Company</button>
                <button id="bulkShowStageBtn" class="button small">Show Stage</button>
                <button id="bulkHideStageBtn" class="button small">Hide Stage</button>
                <button id="bulkShowIncreaseBtn" class="button small">Show %</button>
                <button id="bulkHideIncreaseBtn" class="button small">Hide %</button>
                <button id="bulkShowAmountBtn" class="button small">Show $</button>
                <button id="bulkHideAmountBtn" class="button small">Hide $</button>
                <button id="bulkShowRoleBtn" class="button small">Show Role</button>
                <button id="bulkHideRoleBtn" class="button small">Hide Role</button>
                <button id="bulkClearOverridesBtn" class="button small secondary">Clear Overrides</button>
            </div>
            <button id="modalSaveDataBtn" class="button">Save to CSV</button>
            <button id="modalExportCsvBtn" class="button secondary">Export CSV</button>
            <button id="modalLoadDataBtn" class="button">Load from CSV</button>
            <button id="applyBulkRulesBtn" class="button" style="background: #10b981;">Apply Bulk Rules</button>
        </div>
        
        <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; margin-bottom: 16px; font-size: 0.85rem;">
            <strong>Per-Row Display Controls Guide:</strong><br>
            <span style="color: #4caf50;">✓ Green checkbox with checkmark</span> = Row-specific override active<br>
            <span style="opacity: 0.6;">🌐 Dimmed checkbox with globe</span> = Using global default setting<br>
            🔄 Reset button clears all overrides for that row (returns to global defaults)
        </div>
        
        <div class="editor-help">
            <p><strong>Google Sheets-like Features:</strong></p>
            <ul>
                <li>Click cells to select • Ctrl+Click for multi-select</li>
                <li>Use arrow keys or Tab to navigate between cells</li>
                <li>Copy data from Excel/Sheets and paste with Ctrl+V</li>
                <li>Bulk paste: Select starting cell, then paste tab-separated data</li>
                <li>Ctrl+A to select all cells</li>
            </ul>
        </div>

        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th></th> <!-- Drag handle column -->
                    <th class="sortable" data-field="date">Date <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="company">Company <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="stage">Stage <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="increase">Increase % <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="amount">Amount <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="department">Department <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-field="role">Role <span class="sort-indicator">↕</span></th>
                    <th>Show Company<br><small>Per-Row Override</small></th>
                    <th>Show Stage<br><small>Per-Row Override</small></th>
                    <th>Show %<br><small>Per-Row Override</small></th>
                    <th>Show $<br><small>Per-Row Override</small></th>
                    <th>Show Role<br><small>Per-Row Override</small></th>
                    <th>Actions</th> <!-- Delete button column -->
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Data rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // Widget Data and State Management
        class NegotiationWidget {
            constructor() {
                this.showHidden = false;
                this.data = []; // Data will be loaded from CSV
                this.currentStyles = ['card', 'pill', 'banner'];
                this.isPlaying = true;
                this.isDragging = false;
                this.draggedCard = null;
                this.valuePriority = 'amount';
                this.currentPalette = null;
                this.selectedCells = new Set();
                this.copiedData = null;
                
                // Initialize components that exist
                this.setupEventListeners();
                this.initializeStylePresets();
                
                // Load data - this will auto-load immediately
                this.loadCSVData();
            }

            loadCSVData() {
                // Check if we're running from file:// protocol (local file)
                if (window.location.protocol === 'file:') {
                    console.log('Running from local file, using embedded data to avoid CORS issues');
                    this.loadEmbeddedData();
                    return;
                }
                
                // Use XMLHttpRequest for web server access
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'negotiation-wins-data.csv', true);
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200 || xhr.status === 0) { // 0 for local file access
                            // Successfully loaded the CSV
                            this.parseCSVData(xhr.responseText);
                            this.populateDataTable();
                            this.renderAllWidgets();
                        } else {
                            // If XMLHttpRequest fails, try embedded data as fallback
                            console.log('XMLHttpRequest failed, using embedded data');
                            this.loadEmbeddedData();
                        }
                    }
                };
                
                xhr.onerror = () => {
                    console.log('XHR error, using embedded data');
                    this.loadEmbeddedData();
                };
                
                try {
                    xhr.send();
                } catch (e) {
                    console.log('XHR send failed, using embedded data');
                    this.loadEmbeddedData();
                }
            }
            
            loadEmbeddedData() {
                // Embedded CSV data as fallback for local file access
                const csvData = `date,company,stage,increase,amount,department,role,hidden,showCompany,showStage,showIncrease,showAmount,showRole
2025-09-12,Google,MAANG,48.83,173000,Engineering,Mid,false,false,true,true,true,true
2025-09-12,Airbnb,Public Tech,14.94,65000,Product,Staff,false,false,true,true,true,true
2025-09-08,Meta,MAANG,26.83,117450,Engineering,Staff,false,false,true,true,true,true
2025-09-02,Onward,Unicorn,32.15,118950,Product,C-level,false,false,true,true,true,true
2025-08-28,Google,MAANG,52.76,312927.98,Engineering,Principal,false,false,true,true,true,true
2025-08-21,Meta,MAANG,19.27,113049.29,Engineering,Staff,false,false,true,true,true,true
2025-08-20,Amazon,MAANG,3.56,14643.46,Sales,Senior Manager,false,false,true,false,false,true
2025-08-13,Venteur,Unicorn,20.24,69299.07,Product,VP,false,false,true,true,true,true
2025-08-13,Meta,MAANG,20.24,80921.4,Engineering,Staff,false,false,true,true,true,true
2025-08-08,Snowflake,Unicorn,10.90,36400,Engineering,Mid,false,false,true,true,true,true
2025-08-08,Hinge Health,Unicorn,19.72,63350,Product,Senior,false,false,true,true,true,true
2025-08-06,Symbiotic,Series A,0.00,0,Engineering,Senior,false,false,true,false,false,true
2025-08-04,PayPal,Public Tech,39.10,181333.33,Data,Manager,false,false,true,true,true,true
2025-08-04,Oracle,Big Tech,12.88,38000,Engineering,Senior,false,false,true,true,true,true
2025-07-31,Customer.io,Series B,19.82,58400,Legal,Director,false,false,true,true,true,true
2025-07-30,Salesforce,Public Tech,8.00,15000,Sales,Senior,false,false,true,false,false,true
2025-07-30,Meta,MAANG,22.25,90100,Engineering,Senior,false,false,true,true,true,true
2025-07-24,Comulate,Series A,15.00,45776,Product,Lead,false,false,true,true,true,true
2025-07-15,Adobe,Public Tech,0.00,0,Marketing,Senior Manager,false,false,true,false,false,true
2025-07-11,Meta,MAANG,25.16,43559,Design,Senior,false,false,true,true,true,true
2025-07-08,Amazon,MAANG,8.85,53036.24,Engineering,Senior,false,false,true,false,true,true
2025-07-01,DropBox,Public Tech,20.63,125213,Engineering,Senior Manager,false,false,true,true,true,true
2025-06-30,Netflix,MAANG,2.56,0,Design,Senior,false,false,true,false,false,true
2025-06-23,Applied Intuition,Series B,12.05,51925,Engineering,Staff,false,false,true,true,true,true
2025-06-17,Solventum,Public Tech,2.67,0,Engineering,Senior,false,false,true,false,false,true
2025-06-16,Meta,MAANG,27.24,102600,Engineering,Senior,false,false,true,true,true,true
2025-06-13,Perplexity,Unicorn,18.15,101875,Data,Director,false,false,true,true,true,true
2025-05-28,Databricks,Unicorn,5.60,13614.84,Engineering,Senior,false,false,true,false,false,true
2025-05-28,MongoDB,Public Tech,44.36,155250,Engineering,Staff,false,true,true,true,true,true
2025-05-27,ElevenLabs,Unicorn,0.00,0,Sales,Mid,false,false,true,false,false,true
2025-05-27,Supio,Series A,23.68,45000,Engineering,Senior,false,false,true,true,true,true
2025-05-15,NY Life,Public Tech,10.42,34950,Engineering,Director,false,false,true,true,true,true
2025-05-15,Flagship,Series A,5.38,95812,Other,Senior,false,false,true,false,true,true
2025-05-15,Google,MAANG,6.97,87500,Engineering,Director,false,false,true,false,true,true
2025-05-13,SciTek,Series A,19.14,98591,Engineering,Senior,false,false,true,true,true,true
2025-05-12,Omnus,Series A,14.82,95812,Product,C-level,false,false,true,true,true,true
2025-04-30,Athena,Series B,0.00,45000,Product,Director,false,false,true,false,true,true
2025-04-21,Omada,Series E,4.55,34950,Product,Senior,false,false,true,false,true,true
2025-04-18,ByteDance,Pre-IPO,12.63,36300,Engineering,Senior,false,false,true,true,true,true
2025-04-16,Uber,Public Tech,9.26,68345,Engineering,Staff,false,true,true,false,true,true
2025-04-16,Armada AI,Series B,0.00,0,Marketing,Director,false,false,true,false,false,true
2025-04-11,HubSpot,Public Tech,40.31,259000,Engineering,Director,false,false,true,true,true,true
2025-04-09,Qualitate,Series A,18.75,0,Data,Senior,false,false,true,true,false,true
2025-04-08,Chainalysis,Unicorn,8.89,0,Design,Senior,false,false,true,false,false,true
2025-04-03,ServiceNow,Public Tech,13.80,75500,Operations,Principal,false,false,true,true,true,true
2025-03-31,Red Hat,Public Tech,0.00,94000,Program Management,Director,false,false,true,false,true,true
2025-03-27,Latent,Series A,20.00,111280.5,Engineering,VP,false,false,true,true,true,true
2025-03-27,Wells Fargo,Big Tech,92.53,115845.18,Finance,Senior,false,false,true,true,true,true
2025-03-25,Lumen,Public Tech,17.22,150333,Operations,SVP,false,false,true,true,true,true
2025-03-24,Lennar,Public Tech,0.00,0,Product,VP,false,false,true,false,false,true
2025-03-24,eBay,Public Tech,14.73,60000,Legal,Senior,false,false,true,true,true,true
2025-03-13,Amazon,MAANG,18.00,95812,Product,Senior,false,false,true,true,true,true
2025-03-10,You.com,Series B,25.00,0,Operations,C-level,false,false,true,true,false,true
2025-02-27,Google,MAANG,20.28,132376,Engineering,Staff,false,false,true,true,true,true
2025-02-27,Diligent Co.,Public Tech,12.18,35750,Engineering,Director,false,false,true,true,true,true
2025-02-21,Amazon,MAANG,11.16,43278,Product,Senior,false,false,true,true,true,true
2025-02-18,Figma,Unicorn,14.13,57500,Product,Senior,false,false,true,true,true,true
2025-02-06,Intuit,Public Tech,12.96,52500,Product,Group,false,false,true,true,true,true
2025-01-27,Ashby,Series C,11.91,25000,Product,Senior,false,false,true,true,false,true
2025-01-22,Meta,MAANG,14.68,57250,Engineering,Staff,false,false,true,true,true,true
2025-01-21,WeatherPromise,Series A,14.29,0,Product,Senior,false,false,true,true,false,true
2025-01-09,You.com,Series B,25.00,440000,Other,C-level,false,false,true,true,true,true
2025-01-09,Expedia,Public Tech,48.86,158825,Product,Director,false,false,true,true,true,true
2024-12-19,Modern Treasury,Series C,20.49,98591,Operations,Senior Director,false,false,true,true,true,true
2024-12-10,Great Gray,Series A,0.00,370000,Engineering,C-level,false,false,true,false,true,true
2024-12-03,Apple,MAANG,8.95,38800,Marketing,Senior Manager,false,false,true,false,true,true
2024-11-01,StockX,Unicorn,22.94,107000,Product,Director,false,false,true,true,true,true
2025-09-14,Harvey AI,Series C,0.00,0,Engineering,Senior,false,false,true,false,false,true
2025-09-14,Arm,Public Tech,0.00,0,Product,Senior Director,false,false,true,false,false,true
2023-12-15,Coursera,Public Tech,0.00,120000,Product,Group,false,true,true,false,true,true
2023-11-20,LiveRamp,Public Tech,0.00,67000,Engineering,Staff TPM,false,false,true,false,true,true
2023-10-05,Adobe,Public Tech,0.00,115000,Product,Principal,false,false,true,false,true,true`;
                
                this.parseCSVData(csvData);
                this.populateDataTable();
                this.renderAllWidgets();
            }

            parseCSVData(csvText) {
                // Parse CSV data and populate this.data array
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.error('CSV file must have headers and at least one data row');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const expectedHeaders = ['date', 'company', 'stage', 'increase', 'amount', 'department', 'role', 'hidden', 'showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'];
                
                // Parse CSV data
                const parsedData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length >= 7) { // At least the basic required fields
                        const row = {};
                        
                        // Map each value to its header
                        headers.forEach((header, index) => {
                            let value = values[index] || '';
                            
                            // Convert boolean strings back to booleans
                            if (header.startsWith('show') || header === 'hidden') {
                                if (value === 'true') value = true;
                                else if (value === 'false') value = false;
                                else if (value === '') value = undefined;
                            }
                            
                            // Convert numeric values
                            if (header === 'increase' || header === 'amount') {
                                value = parseFloat(value) || 0;
                            }
                            
                            row[header] = value;
                        });
                        
                        // Ensure all expected headers exist with defaults
                        expectedHeaders.forEach(header => {
                            if (row[header] === undefined) {
                                if (header.startsWith('show')) {
                                    row[header] = true; // Default to showing all fields
                                } else if (header === 'hidden') {
                                    row[header] = false; // Default to not hidden
                                } else {
                                    row[header] = '';
                                }
                            }
                        });
                        
                        // Ensure hidden field is properly set as boolean
                        if (typeof row.hidden === 'string') {
                            row.hidden = row.hidden === 'true';
                        }
                        
                        parsedData.push(row);
                    }
                }
                
                this.data = parsedData;
                const hiddenCount = parsedData.filter(row => row.hidden === true).length;
                console.log(`Parsed ${parsedData.length} rows from CSV data`);
                if (hiddenCount > 0) {
                    console.log(`Found ${hiddenCount} hidden items in CSV data`);
                }
            }

            
            initializeStylePresets() {
                const presets = [
                    {
                        name: 'Dark Tech',
                        colors: ['#333333', '#3F0A3D', '#BA0EF7', '#29CEF9'],
                        font: 'montserrat',
                        shadow: 'heavy'
                    },
                    {
                        name: 'Ocean Blue',
                        colors: ['#001A49', '#14284C', '#3898EC', '#29CEF9'],
                        font: 'roboto',
                        shadow: 'medium'
                    },
                    {
                        name: 'Purple Dream',
                        colors: ['#3F0A3D', '#BA0EF7', '#FCF2FF', '#FAF3FF'],
                        font: 'inter',
                        shadow: 'light'
                    },
                    {
                        name: 'Neon Green',
                        colors: ['#001233', '#1B2D45', '#31F60A', '#29CEF9'],
                        font: 'system',
                        shadow: 'heavy'
                    },
                    {
                        name: 'Soft Pastel',
                        colors: ['#FAF3FF', '#FCF2FF', '#FFF2E7', '#E4EBF3'],
                        font: 'lato',
                        shadow: 'light'
                    },
                    {
                        name: 'Corporate',
                        colors: ['#14284C', '#4F596A', '#E7EAEB', '#3898EC'],
                        font: 'opensans',
                        shadow: 'medium'
                    }
                ];
                
                const presetsContainer = document.getElementById('stylePresets');
                if (presetsContainer) {
                    presetsContainer.innerHTML = presets.map(preset => `
                        <div class="preset-button" data-preset='${JSON.stringify(preset)}'>
                            <div class="preset-name">${preset.name}</div>
                            <div class="preset-preview">
                                ${preset.colors.map(color => 
                                    `<div class="preset-color" style="background-color: ${color};"></div>`
                                ).join('')}
                            </div>
                        </div>
                    `).join('');
                    
                    // Add click handlers to presets
                    presetsContainer.querySelectorAll('.preset-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const preset = JSON.parse(e.currentTarget.dataset.preset);
                            this.applyPreset(preset);
                        });
                    });
                }
            }
            
            applyColorToActive(color) {
                // Find which color picker is currently focused or use primary by default
                const activeInput = document.activeElement;
                let targetId = 'primaryColor';
                
                if (activeInput && activeInput.type === 'color') {
                    targetId = activeInput.id;
                } else {
                    // Show visual feedback on primary color
                    const primaryInput = document.getElementById('primaryColor');
                    if (primaryInput) {
                        primaryInput.focus();
                    }
                }
                
                // Apply the color
                const input = document.getElementById(targetId);
                if (input) {
                    input.value = color;
                    this.updateColor(targetId, color);
                }
                
                // Update active swatch indicator
                document.querySelectorAll('.color-swatch').forEach(s => {
                    s.classList.toggle('active', s.dataset.color === color);
                });
            }
            
            applyPreset(preset) {
                // Apply colors
                if (preset.colors && preset.colors.length >= 4) {
                    document.getElementById('primaryColor').value = preset.colors[0];
                    document.getElementById('secondaryColor').value = preset.colors[1];
                    document.getElementById('successColor').value = preset.colors[2];
                    document.getElementById('accentColor').value = preset.colors[3];
                    
                    this.updateColor('primaryColor', preset.colors[0]);
                    this.updateColor('secondaryColor', preset.colors[1]);
                    this.updateColor('successColor', preset.colors[2]);
                    this.updateColor('accentColor', preset.colors[3]);
                }
                
                // Apply font
                if (preset.font) {
                    document.getElementById('fontFamily').value = preset.font;
                    this.updateFontFamily(preset.font);
                }
                
                // Apply shadow
                if (preset.shadow) {
                    document.getElementById('shadowIntensity').value = preset.shadow;
                    this.updateShadowIntensity(preset.shadow);
                }
            }

            setupEventListeners() {
                // Speed control (number input)
                document.getElementById('speedInput').addEventListener('input', (e) => {
                    const speed = e.target.value;
                    document.documentElement.style.setProperty('--animation-duration', `${speed}s`);
                    
                    // Update all individual tracks
                    const tracks = document.querySelectorAll('.infinite-scroll-track');
                    tracks.forEach(track => {
                        track.style.setProperty('--animation-duration', `${speed}s`);
                    });
                });

                // Play/Pause control
                document.getElementById('playPauseBtn').addEventListener('click', () => {
                    this.toggleAnimation();
                });

                // Reset button
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetAnimation();
                });

                // Style pill selection
                document.querySelectorAll('.style-pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        const style = e.target.dataset.style;
                        this.toggleStyle(style);
                    });
                });

                // Color pickers
                ['primaryColor', 'secondaryColor', 'successColor', 'accentColor'].forEach(colorId => {
                    document.getElementById(colorId).addEventListener('change', (e) => {
                        this.updateColor(colorId, e.target.value);
                    });
                });

                // Typography controls
                document.getElementById('fontFamily').addEventListener('change', (e) => {
                    this.updateFontFamily(e.target.value);
                });

                document.getElementById('fontSize').addEventListener('input', (e) => {
                    this.updateFontSize(e.target.value);
                });

                // Spacing controls
                document.getElementById('cardPadding').addEventListener('input', (e) => {
                    this.updateCardPadding(e.target.value);
                });

                document.getElementById('cardGap').addEventListener('input', (e) => {
                    this.updateCardGap(e.target.value);
                });

                document.getElementById('borderRadius').addEventListener('input', (e) => {
                    this.updateBorderRadius(e.target.value);
                });

                document.getElementById('shadowIntensity').addEventListener('change', (e) => {
                    this.updateShadowIntensity(e.target.value);
                });

                // Display options
                ['showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'].forEach(optionId => {
                    const element = document.getElementById(optionId);
                    if (element) {
                        console.log('Setting up event listener for:', optionId);
                        element.addEventListener('change', () => {
                            console.log('Display option changed:', optionId, element.checked);
                            this.updateDisplayOptions();
                        });
                    } else {
                        console.error('Element not found:', optionId);
                    }
                });

                // Value priority
                document.getElementById('valuePriority').addEventListener('change', (e) => {
                    this.valuePriority = e.target.value;
                    this.renderAllWidgets();
                });
                
                // Number formatting controls
                document.getElementById('useShortForm').addEventListener('change', (e) => {
                    this.useShortForm = e.target.checked;
                    this.renderAllWidgets();
                });
                
                document.getElementById('amountDecimals').addEventListener('change', (e) => {
                    this.amountDecimals = parseInt(e.target.value);
                    this.renderAllWidgets();
                });
                
                document.getElementById('percentDecimals').addEventListener('change', (e) => {
                    this.percentDecimals = parseInt(e.target.value);
                    this.renderAllWidgets();
                });

                // Data management
                document.getElementById('editDataBtn').addEventListener('click', () => {
                    this.openDataEditor();
                });
                
                // Copy to clipboard for Webflow
                document.getElementById('copyCardBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('card');
                });
                
                document.getElementById('copyPillBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('pill');
                });
                
                document.getElementById('copyPillCompactBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('pill-compact');
                });
                
                document.getElementById('copyPillMinimalBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('pill-minimal');
                });
                
                document.getElementById('copyPillCardBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('pill-card');
                });
                
                document.getElementById('copyPillBadgeBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('pill-badge');
                });
                
                document.getElementById('copyBannerBtn').addEventListener('click', () => {
                    this.copyWidgetToClipboard('banner');
                });
                
                document.getElementById('copyAllBtn').addEventListener('click', () => {
                    this.copyAllWidgetsToClipboard();
                });

                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('importDataBtn').addEventListener('click', () => {
                    document.getElementById('importFile').click();
                });

                document.getElementById('importFile').addEventListener('change', (e) => {
                    this.importData(e.target.files[0]);
                });

                // Data editor
                document.getElementById('closeEditor').addEventListener('click', () => {
                    this.closeDataEditor();
                });

                document.getElementById('addRowBtn').addEventListener('click', () => {
                    this.addDataRow();
                });

                document.getElementById('hideRowBtn').addEventListener('click', () => {
                    this.hideSelectedRows();
                });
                
                document.getElementById('showHiddenBtn').addEventListener('click', () => {
                    this.toggleShowHidden();
                });
                
                document.getElementById('reloadFullDataBtn')?.addEventListener('click', () => {
                    // Force reload from CSV data
                    this.loadDataFromCSV();
                    alert('Reloaded all data from CSV!');
                });
                

                document.getElementById('copyBtn').addEventListener('click', () => {
                    this.copySelectedCells();
                });

                document.getElementById('pasteBtn').addEventListener('click', () => {
                    this.pasteToSelectedCells();
                });
                
                document.getElementById('selectAllBtn').addEventListener('click', () => {
                    this.selectAllCells();
                });

                document.getElementById('saveDataBtn').addEventListener('click', () => {
                    this.saveDataChanges();
                });

                document.getElementById('exportCsvBtn').addEventListener('click', () => {
                    this.saveDataToCSV();
                });

                // Modal button event listeners
                document.getElementById('modalSaveDataBtn').addEventListener('click', () => {
                    this.saveDataChanges();
                });

                document.getElementById('modalExportCsvBtn').addEventListener('click', () => {
                    this.saveDataToCSV();
                });

                document.getElementById('modalLoadDataBtn').addEventListener('click', () => {
                    this.loadDataFromCSV();
                });

                document.getElementById('applyBulkRulesBtn').addEventListener('click', () => {
                    this.applyBulkRules();
                });
                
                document.getElementById('showRowBtn').addEventListener('click', () => {
                    this.showSelectedRows();
                });
                
                // Bulk edit listeners
                document.getElementById('bulkShowCompanyBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showCompany', true);
                });
                document.getElementById('bulkHideCompanyBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showCompany', false);
                });
                document.getElementById('bulkShowStageBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showStage', true);
                });
                document.getElementById('bulkHideStageBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showStage', false);
                });
                document.getElementById('bulkShowIncreaseBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showIncrease', true);
                });
                document.getElementById('bulkHideIncreaseBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showIncrease', false);
                });
                document.getElementById('bulkShowAmountBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showAmount', true);
                });
                document.getElementById('bulkHideAmountBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showAmount', false);
                });
                document.getElementById('bulkShowRoleBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showRole', true);
                });
                document.getElementById('bulkHideRoleBtn').addEventListener('click', () => {
                    this.bulkEditSelected('showRole', false);
                });
                document.getElementById('bulkClearOverridesBtn').addEventListener('click', () => {
                    this.bulkClearOverrides();
                });

                // Theme selection
                document.getElementById('themeSelect').addEventListener('change', (e) => {
                    this.changeTheme(e.target.value);
                });

                // Close editor on overlay click
                document.getElementById('editorOverlay').addEventListener('click', () => {
                    this.closeDataEditor();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'c':
                                e.preventDefault();
                                this.copySelectedCells();
                                break;
                            case 'v':
                                e.preventDefault();
                                this.pasteToSelectedCells();
                                break;
                            case 's':
                                e.preventDefault();
                                this.saveDataChanges();
                                break;
                        }
                    }
                    if (e.key === 'Escape') {
                        this.closeDataEditor();
                    }
                });
            }

            toggleAnimation() {
                const tracks = document.querySelectorAll('.infinite-scroll-track');
                const btn = document.getElementById('playPauseBtn');
                
                if (this.isPlaying) {
                    tracks.forEach(track => {
                        track.style.animationPlayState = 'paused';
                    });
                    btn.textContent = 'Play';
                    this.isPlaying = false;
                } else {
                    tracks.forEach(track => {
                        track.style.animationPlayState = 'running';
                    });
                    btn.textContent = 'Pause';
                    this.isPlaying = true;
                }
            }

            resetAnimation() {
                const tracks = document.querySelectorAll('.infinite-scroll-track');
                tracks.forEach(track => {
                    track.style.animation = 'none';
                    track.offsetHeight; // Trigger reflow
                    track.style.animation = null;
                });
            }

            toggleStyle(style) {
                const pill = document.querySelector(`[data-style="${style}"]`);
                const index = this.currentStyles.indexOf(style);
                
                if (index > -1) {
                    // Remove style
                    this.currentStyles.splice(index, 1);
                    pill.classList.remove('active');
                } else {
                    // Add style
                    this.currentStyles.push(style);
                    pill.classList.add('active');
                }
                
                this.updateStyleVisibility();
            }

            updateStyleVisibility() {
                const wrappers = document.querySelectorAll('.infinite-scroll-wrapper');
                const styleOrder = ['card', 'pill', 'banner'];
                
                wrappers.forEach((wrapper, index) => {
                    const style = styleOrder[index];
                    if (this.currentStyles.includes(style)) {
                        wrapper.style.display = 'block';
                    } else {
                        wrapper.style.display = 'none';
                    }
                });
            }

            updateColor(colorType, value) {
                const colorMap = {
                    'primaryColor': '--primary-color',
                    'secondaryColor': '--secondary-color',
                    'successColor': '--success-color',
                    'accentColor': '--accent-color'
                };
                
                document.documentElement.style.setProperty(colorMap[colorType], value);
                
                // Update gradients to use new colors
                this.updateGradients();
                
                // Re-render widgets to apply new colors
                this.renderAllWidgets();
            }

            getCompanyIcon(company, stage) {
                // Generate meaningful flat filled icons based on company stage
                const icons = {
                    'MAANG': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- MAANG text logos -->
                        <text x="24" y="28" text-anchor="middle" font-size="14" font-weight="900" font-family="Arial Black">MAANG</text>
                    </svg>`,
                    'Public Tech': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- Upward trending chart -->
                        <rect x="8" y="32" width="6" height="8"/>
                        <rect x="17" y="26" width="6" height="14"/>
                        <rect x="26" y="20" width="6" height="20"/>
                        <rect x="35" y="14" width="6" height="26"/>
                        <path d="M8 16L14 10L22 14L30 6L38 10" stroke="white" stroke-width="3" fill="none"/>
                    </svg>`,
                    'Unicorn': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- Unicorn horn -->
                        <path d="M24 4l-4 16h2l1-4 1 4 1-4 1 4h2L24 4zm-6 16c0 8 6 20 6 20s6-12 6-20h-12z"/>
                        <circle cx="24" cy="24" r="3" fill="rgba(255,255,255,0.4)"/>
                    </svg>`,
                    'Series A': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.2)"/>
                        <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="26" font-weight="900" fill="white">A</text>
                    </svg>`,
                    'Series B': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.25)"/>
                        <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="26" font-weight="900" fill="white">B</text>
                    </svg>`,
                    'Series C': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.3)"/>
                        <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="26" font-weight="900" fill="white">C</text>
                    </svg>`,
                    'Series D': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.35)"/>
                        <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="26" font-weight="900" fill="white">D</text>
                    </svg>`,
                    'Series E': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.4)"/>
                        <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="26" font-weight="900" fill="white">E</text>
                    </svg>`,
                    'Big Tech': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- Server/datacenter icon -->
                        <rect x="8" y="8" width="32" height="8" rx="2"/>
                        <rect x="8" y="20" width="32" height="8" rx="2"/>
                        <rect x="8" y="32" width="32" height="8" rx="2"/>
                        <circle cx="36" cy="12" r="2" fill="currentColor"/>
                        <circle cx="36" cy="24" r="2" fill="currentColor"/>
                        <circle cx="36" cy="36" r="2" fill="currentColor"/>
                    </svg>`,
                    'Decacorn': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- Diamond icon for high value -->
                        <path d="M24 4L8 20l16 24 16-24L24 4zm0 8l8 8-8 12-8-12 8-8z" fill="white"/>
                    </svg>`,
                    'Pre-IPO': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                        <!-- Rocket launching icon -->
                        <path d="M24 4c0 8-4 12-8 16l4 4v20l4-8 4 8V24l4-4c-4-4-8-8-8-16zm-4 28l-4 4 4 4 4-4-4-4zm8 0l-4 4 4 4 4-4-4-4z"/>
                    </svg>`
                };
                
                // Return icon based on stage, or first letter of stage as fallback
                return icons[stage] || `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="white">
                    <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.2)"/>
                    <text x="24" y="24" text-anchor="middle" dominant-baseline="central" font-size="24" font-weight="900" fill="white">${stage ? stage.charAt(0).toUpperCase() : '?'}</text>
                </svg>`;
            }

            updateFontFamily(fontFamily) {
                const fontMap = {
                    'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    'inter': '"Inter", sans-serif',
                    'roboto': '"Roboto", sans-serif',
                    'opensans': '"Open Sans", sans-serif',
                    'lato': '"Lato", sans-serif',
                    'montserrat': '"Montserrat", sans-serif',
                    'poppins': '"Poppins", sans-serif'
                };
                
                document.documentElement.style.setProperty('--font-family', fontMap[fontFamily] || fontMap['system']);
                
                // Update font preview
                const preview = document.getElementById('fontPreview');
                if (preview) {
                    preview.style.fontFamily = fontMap[fontFamily] || fontMap['system'];
                }
                
                // Re-render widgets to apply font changes
                this.renderAllWidgets();
            }

            updateFontSize(size) {
                document.documentElement.style.setProperty('--base-font-size', `${size}px`);
                // Update specific font sizes for different elements
                document.documentElement.style.setProperty('--card-title-size', `${size * 1.5}px`);
                document.documentElement.style.setProperty('--card-value-size', `${size * 2.5}px`);
                document.documentElement.style.setProperty('--pill-text-size', `${size * 1.125}px`);
                document.documentElement.style.setProperty('--banner-title-size', `${size * 2}px`);
                
                // Re-render to apply changes
                this.renderAllWidgets();
            }

            updateCardPadding(padding) {
                document.documentElement.style.setProperty('--card-padding', `${padding}px`);
                // Also update pill and banner padding proportionally
                document.documentElement.style.setProperty('--pill-padding', `${padding * 0.67}px ${padding}px`);
                document.documentElement.style.setProperty('--banner-padding', `${padding * 1.33}px`);
                
                // Re-render to apply changes
                this.renderAllWidgets();
            }

            updateCardGap(gap) {
                document.documentElement.style.setProperty('--card-gap', `${gap}px`);
                // Pills and banners use the same gap
                document.documentElement.style.setProperty('--widget-gap', `${gap}px`);
                
                // Re-render to apply changes
                this.renderAllWidgets();
            }

            updateBorderRadius(radius) {
                document.documentElement.style.setProperty('--border-radius', `${radius}px`);
                // Pills use full rounded, banners use larger radius
                document.documentElement.style.setProperty('--pill-radius', `50px`);
                document.documentElement.style.setProperty('--banner-radius', `${radius * 1.67}px`);
                
                // Re-render to apply changes
                this.renderAllWidgets();
            }
            
            updateShadowIntensity(intensity) {
                const shadowMap = {
                    'none': 'none',
                    'light': '0 2px 4px rgba(0,0,0,0.1)',
                    'medium': '0 4px 12px rgba(0,0,0,0.15)',
                    'heavy': '0 10px 30px rgba(0,0,0,0.2)'
                };
                
                const glassMap = {
                    'none': 'none',
                    'light': '0 4px 16px rgba(31, 38, 135, 0.1)',
                    'medium': '0 8px 32px rgba(31, 38, 135, 0.15)',
                    'heavy': '0 12px 48px rgba(31, 38, 135, 0.2)'
                };
                
                document.documentElement.style.setProperty('--shadow-sm', shadowMap[intensity]);
                document.documentElement.style.setProperty('--shadow-md', shadowMap[intensity]);
                document.documentElement.style.setProperty('--shadow-lg', shadowMap[intensity]);
                document.documentElement.style.setProperty('--glass-shadow', glassMap[intensity]);
                
                // Re-render to apply changes
                this.renderAllWidgets();
            }

            lightenColor(color, percent) {
                // Helper function to lighten a color
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                    (B < 255 ? B < 1 ? 0 : B : 255))
                    .toString(16).slice(1);
            }
            
            updateGradients() {
                const primaryColor = document.getElementById('primaryColor')?.value || '#5E5ADB';
                const secondaryColor = document.getElementById('secondaryColor')?.value || '#FF6B6B';
                const successColor = document.getElementById('successColor')?.value || '#4ECDC4';
                const accentColor = document.getElementById('accentColor')?.value || '#9C27B0';
                
                // Create new gradients with updated colors
                const root = document.documentElement;
                root.style.setProperty('--gradient-1', `linear-gradient(135deg, ${primaryColor} 0%, ${this.lightenColor(primaryColor, 20)} 100%)`);
                root.style.setProperty('--gradient-2', `linear-gradient(135deg, ${secondaryColor} 0%, ${this.lightenColor(secondaryColor, 20)} 100%)`);
                root.style.setProperty('--gradient-3', `linear-gradient(135deg, ${successColor} 0%, ${this.lightenColor(successColor, 20)} 100%)`);
                root.style.setProperty('--gradient-4', `linear-gradient(135deg, ${accentColor} 0%, ${primaryColor} 100%)`);
            }

            lightenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }
            
            formatAmount(amount) {
                // Convert string amount to number (removing commas)
                const numAmount = typeof amount === 'string' ? 
                    parseFloat(amount.replace(/,/g, '')) : 
                    parseFloat(amount);
                
                if (this.useShortForm) {
                    // Convert to K format
                    if (numAmount >= 1000) {
                        const kAmount = numAmount / 1000;
                        return `${kAmount.toFixed(this.amountDecimals)}K`;
                    }
                    return numAmount.toFixed(this.amountDecimals);
                } else {
                    // Use full number with commas
                    return numAmount.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                }
            }
            
            formatPercentage(percent) {
                const numPercent = typeof percent === 'string' ? 
                    parseFloat(percent) : 
                    parseFloat(percent);
                
                return `${numPercent.toFixed(this.percentDecimals)}%`;
            }

            updateCSSVariables() {
                const root = document.documentElement;
                const primaryColor = document.getElementById('primaryColor')?.value || '#5E5ADB';
                const secondaryColor = document.getElementById('secondaryColor')?.value || '#FF6B6B';
                const successColor = document.getElementById('successColor')?.value || '#4ECDC4';
                const accentColor = document.getElementById('accentColor')?.value || '#9C27B0';

                root.style.setProperty('--primary-color', primaryColor);
                root.style.setProperty('--secondary-color', secondaryColor);
                root.style.setProperty('--success-color', successColor);
                root.style.setProperty('--accent-color', accentColor);
            }

            updateDisplayOptions() {
                console.log('Global display options changed:');
                console.log('showCompany:', document.getElementById('showCompany')?.checked);
                console.log('showStage:', document.getElementById('showStage')?.checked); 
                console.log('showIncrease:', document.getElementById('showIncrease')?.checked);
                console.log('showAmount:', document.getElementById('showAmount')?.checked);
                console.log('showRole:', document.getElementById('showRole')?.checked);
                this.renderAllWidgets();
            }

            toggleAllStyles() {
                const wrappers = document.querySelectorAll('.infinite-scroll-wrapper');
                
                if (this.showAllStyles) {
                    wrappers.forEach(wrapper => {
                        wrapper.style.display = 'block';
                    });
                } else {
                    // Show only the selected style
                    this.changeStyle(this.currentStyle);
                }
            }

            renderAllWidgets() {
                // Render cards
                this.renderCardWidget();
                // Render pills
                this.renderPillWidget();
                this.renderPillCompactWidget();
                this.renderPillMinimalWidget();
                this.renderPillCardWidget();
                this.renderPillBadgeWidget();
                // Render banners
                this.renderBannerWidget();
            }

            renderCardWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[0];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generateCardHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }

            renderPillWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[1];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generatePillHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }

            renderPillCompactWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[2];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generatePillCompactHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }
            renderPillMinimalWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[3];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generatePillMinimalHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }
            renderPillCardWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[4];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generatePillCardHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }
            renderPillBadgeWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[5];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generatePillBadgeHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }
            renderBannerWidget() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[6];
                if (wrapper) {
                    const track = wrapper.querySelector('.infinite-scroll-track');
                    if (track) {
                        const html = this.generateBannerHTML();
                        // Create THREE copies for smooth infinite scroll (scrolls by 33.33%)
                        track.innerHTML = `
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                            <div class="infinite-scroll-content">${html}</div>
                        `;
                    }
                }
            }

            generateCardHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    console.log('Card generation - Global settings:', {
                        showCompany: globalShowCompany,
                        showStage: globalShowStage, 
                        showIncrease: globalShowIncrease,
                        showAmount: globalShowAmount,
                        showRole: globalShowRole
                    });
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;

                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);
                    const showingBoth = showAmount && showIncrease;
                    
                    console.log(`Card ${index} - Debug Values:`, {
                        company: item.company,
                        rawIncrease: item.increase,
                        formattedPercent: formattedPercent,
                        showIncrease: showIncrease,
                        showAmount: showAmount,
                        showingBoth: showingBoth,
                        itemShowIncrease: item.showIncrease,
                        globalShowIncrease: globalShowIncrease
                    });
                    
                    // Determine what should be primary for THIS specific item
                    // If showing only one value, that becomes primary regardless of global valuePriority
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }
                    
                    console.log(`Card ${index} - Final display settings:`, {
                        company: item.company,
                        showCompany, showStage, showIncrease, showAmount, showRole,
                        showingBoth, itemValuePriority
                    });

                    return `
                        <div class="win-card" data-index="${index}">
                            <div class="card-icon">${this.getCompanyIcon(item.company, item.stage)}</div>
                            ${showCompany || !showStage ? `<div class="card-company">${item.company}</div>` : ''}
                            ${showStage ? `<div class="card-stage">${item.stage}</div>` : ''}
                            ${(() => {
                                let valueHtml = '';
                                if (showingBoth) {
                                    // Showing both values
                                    if (itemValuePriority === 'amount') {
                                        valueHtml += `<div class="card-amount">+$${formattedAmount}</div>`;
                                        valueHtml += `<div class="card-increase secondary">+${formattedPercent}</div>`;
                                    } else {
                                        valueHtml += `<div class="card-increase">+${formattedPercent}</div>`;
                                        valueHtml += `<div class="card-amount secondary">+$${formattedAmount}</div>`;
                                    }
                                } else {
                                    // Showing only one value
                                    if (showAmount) {
                                        valueHtml += `<div class="card-amount">+$${formattedAmount}</div>`;
                                    }
                                    if (showIncrease) {
                                        valueHtml += `<div class="card-increase">+${formattedPercent}</div>`;
                                    }
                                }
                                return valueHtml;
                            })()}
                            ${showRole ? `
                                <div class="card-details">
                                    <span class="card-badge">${item.department}</span>
                                    <span class="card-badge">${item.role}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            generatePillHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;

                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);

                    // Determine if showing both values or just one
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }

                    return `
                        <div class="win-pill" data-index="${index}">
                            <div class="pill-logo">${this.getCompanyIcon(item.company, item.stage)}</div>
                            <div class="pill-content">
                                ${showCompany || !showStage ? `<div class="pill-company">${item.company}</div>` : ''}
                                ${showStage ? `<div class="pill-stage">${item.stage}</div>` : ''}
                                <div class="pill-stats">
                                    ${(() => {
                                        let valueHtml = '';
                                        if (showingBoth) {
                                            // Showing both values
                                            if (itemValuePriority === 'amount') {
                                                valueHtml += `<span class="pill-amount">+$${formattedAmount}</span>`;
                                                valueHtml += `<span class="pill-increase secondary">+${formattedPercent}</span>`;
                                            } else {
                                                valueHtml += `<span class="pill-increase">+${formattedPercent}</span>`;
                                                valueHtml += `<span class="pill-amount secondary">+$${formattedAmount}</span>`;
                                            }
                                        } else {
                                            // Showing only one value
                                            if (showAmount) {
                                                valueHtml += `<span class="pill-amount">+$${formattedAmount}</span>`;
                                            }
                                            if (showIncrease) {
                                                valueHtml += `<span class="pill-increase">+${formattedPercent}</span>`;
                                            }
                                        }
                                        return valueHtml;
                                    })()}
                                    ${showRole ? `<span class="pill-role">${item.department} • ${item.role}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            generatePillCompactHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;
                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);

                    // Determine if showing both values or just one
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }
                    
                    return `
                        <div class="win-pill-compact">
                            <div class="pill-compact-icon">${this.getCompanyIcon(item.company, item.stage)}</div>
                            <div class="pill-compact-content">
                                ${showCompany || !showStage ? `<div class="pill-compact-company">${item.company}</div>` : ''}
                                ${showStage ? `<div class="pill-compact-stage">${item.stage}</div>` : ''}
                                <div class="pill-compact-values">
                                    ${(() => {
                                        let valueHtml = '';
                                        if (showingBoth) {
                                            // Showing both values
                                            if (itemValuePriority === 'amount') {
                                                valueHtml += `<span class="pill-compact-amount">+$${formattedAmount}</span>`;
                                                valueHtml += `<span class="pill-compact-increase secondary">+${formattedPercent}</span>`;
                                            } else {
                                                valueHtml += `<span class="pill-compact-increase">+${formattedPercent}</span>`;
                                                valueHtml += `<span class="pill-compact-amount secondary">+$${formattedAmount}</span>`;
                                            }
                                        } else {
                                            // Showing only one value
                                            if (showAmount) {
                                                valueHtml += `<span class="pill-compact-amount">+$${formattedAmount}</span>`;
                                            }
                                            if (showIncrease) {
                                                valueHtml += `<span class="pill-compact-increase">+${formattedPercent}</span>`;
                                            }
                                        }
                                        return valueHtml;
                                    })()}
                                    ${showRole ? `<span class="pill-compact-role">${item.department} • ${item.role}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            generatePillMinimalHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;
                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }
                    
                    return `
                        <div class="win-pill-minimal">
                            <div class="pill-minimal-header">
                                ${showCompany || !showStage ? `<span class="pill-minimal-company">${item.company}</span>` : ''}
                                ${showStage ? `<span class="pill-minimal-stage">${item.stage}</span>` : ''}
                            </div>
                            <div class="pill-minimal-value">
                                ${itemValuePriority === 'amount' ? 
                                    (showAmount ? `+$${formattedAmount}` : showIncrease ? `+${formattedPercent}` : '')
                                : 
                                    (showIncrease ? `+${formattedPercent}` : showAmount ? `+$${formattedAmount}` : '')
                                }
                            </div>
                            ${showRole ? `<div class="pill-minimal-role">${item.department} • ${item.role}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            generatePillCardHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;
                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);
                    
                    // Determine if showing both values or just one
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }
                    
                    return `
                        <div class="win-pill-card">
                            <div class="pill-card-header">
                                <div class="pill-card-icon">${this.getCompanyIcon(item.company, item.stage)}</div>
                                <div class="pill-card-info">
                                    ${showCompany || !showStage ? `<div class="pill-card-company">${item.company}</div>` : ''}
                                    ${showStage ? `<div class="pill-card-stage">${item.stage}</div>` : ''}
                                </div>
                            </div>
                            <div class="pill-card-body">
                                <div class="pill-card-main">
                                    ${itemValuePriority === 'amount' ? 
                                        (showAmount ? `<div class="pill-card-amount">+$${formattedAmount}</div>` : '')
                                    : 
                                        (showIncrease ? `<div class="pill-card-increase">+${formattedPercent}</div>` : '')
                                    }
                                </div>
                                <div class="pill-card-secondary">
                                    ${itemValuePriority === 'amount' ? 
                                        (showIncrease ? `<div class="pill-card-percent">+${formattedPercent}</div>` : '')
                                    : 
                                        (showAmount ? `<div class="pill-card-money">+$${formattedAmount}</div>` : '')
                                    }
                                    ${showRole ? `<div class="pill-card-role">${item.department} • ${item.role}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            generatePillBadgeHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;
                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);
                    
                    // Determine if showing both values or just one
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }
                    
                    return `
                        <div class="win-pill-badge">
                            <div class="pill-badge-main">
                                ${itemValuePriority === 'amount' ? 
                                    (showAmount ? `<span class="pill-badge-value">+$${formattedAmount}</span>` : '')
                                : 
                                    (showIncrease ? `<span class="pill-badge-value">+${formattedPercent}</span>` : '')
                                }
                                ${showCompany || !showStage ? `<span class="pill-badge-company">${item.company}</span>` : ''}
                                ${showStage ? `<span class="pill-badge-stage">${item.stage}</span>` : ''}
                            </div>
                            ${showRole ? `<div class="pill-badge-role">${item.department} • ${item.role}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            generateBannerHTML() {
                // Filter out hidden items
                const visibleData = this.data.filter(item => item.hidden !== 'true' && item.hidden !== true);
                return visibleData.map((item, index) => {
                    const globalShowCompany = document.getElementById('showCompany')?.checked ?? false;
                    const globalShowStage = document.getElementById('showStage')?.checked ?? true;
                    const globalShowIncrease = document.getElementById('showIncrease')?.checked ?? true;
                    const globalShowAmount = document.getElementById('showAmount')?.checked ?? true;
                    const globalShowRole = document.getElementById('showRole')?.checked ?? true;
                    
                    // Apply display options with per-item overrides
                    const showCompany = item.showCompany !== undefined ? item.showCompany : globalShowCompany;
                    const showStage = item.showStage !== undefined ? item.showStage : globalShowStage;
                    const showIncrease = item.showIncrease !== undefined ? item.showIncrease : globalShowIncrease;
                    const showAmount = item.showAmount !== undefined ? item.showAmount : globalShowAmount;
                    const showRole = item.showRole !== undefined ? item.showRole : globalShowRole;

                    const formattedAmount = this.formatAmount(item.amount);
                    const formattedPercent = this.formatPercentage(item.increase);

                    // Determine if showing both values or just one
                    const showingBoth = showAmount && showIncrease;
                    
                    // Determine what should be primary for THIS specific item
                    let itemValuePriority;
                    if (showingBoth) {
                        itemValuePriority = this.valuePriority; // Use global setting when showing both
                    } else {
                        itemValuePriority = showAmount ? 'amount' : 'increase'; // Whatever is shown becomes primary
                    }

                    return `
                        <div class="win-banner" data-index="${index}">
                            <div class="banner-header">
                                <div class="banner-company-group">
                                    ${showCompany || !showStage ? `<div class="banner-company">${item.company}</div>` : ''}
                                    ${showStage ? `<div class="banner-stage">${item.stage}</div>` : ''}
                                    ${showRole ? `<div class="banner-role">${item.department} • ${item.role}</div>` : ''}
                                </div>
                                <div class="banner-increase-group">
                                    ${itemValuePriority === 'amount' ? 
                                        (showAmount ? `<div class="banner-amount">+$${formattedAmount}</div>` : '')
                                    : 
                                        (showIncrease ? `<div class="banner-increase">+${formattedPercent}</div>` : '')
                                    }
                                    ${showAmount || showIncrease ? `<div class="banner-increase-label">Year 1 Increase</div>` : ''}
                                </div>
                            </div>
                            <div class="banner-footer">
                                ${itemValuePriority === 'amount' ? 
                                    (showIncrease ? `<div class="banner-increase secondary">+${formattedPercent}</div>` : '')
                                : 
                                    (showAmount ? `<div class="banner-amount secondary">+$${formattedAmount}</div>` : '')
                                }
                                ${showRole ? `<div class="banner-seniority">${item.role}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            openDataEditor() {
                document.getElementById('dataEditor').classList.add('active');
                document.getElementById('editorOverlay').classList.add('active');
                this.populateDataTable();
            }

            closeDataEditor() {
                document.getElementById('dataEditor').classList.remove('active');
                document.getElementById('editorOverlay').classList.remove('active');
            }

            populateDataTable(skipInit = false) {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';

                // Show all data but style hidden rows differently
                this.data.forEach((row, index) => {
                    const isHidden = row.hidden === 'true' || row.hidden === true;
                    const tr = document.createElement('tr');
                    tr.draggable = true;
                    tr.dataset.rowIndex = index;
                    
                    // Add styling for hidden rows
                    if (isHidden) {
                        tr.style.opacity = '0.5';
                        tr.style.backgroundColor = '#f5f5f5';
                    }
                    tr.innerHTML = `
                        <td style="cursor: move; padding: 5px; background: #f0f0f0; text-align: center;" class="drag-handle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </td>
                        <td><input type="date" value="${row.date || ''}" data-field="date" data-row="${index}"></td>
                        <td><input type="text" value="${row.company}" data-field="company" data-row="${index}"></td>
                        <td><input type="text" value="${row.stage}" data-field="stage" data-row="${index}"></td>
                        <td><input type="text" value="${row.increase}" data-field="increase" data-row="${index}"></td>
                        <td><input type="text" value="${row.amount}" data-field="amount" data-row="${index}"></td>
                        <td><input type="text" value="${row.department}" data-field="department" data-row="${index}"></td>
                        <td><input type="text" value="${row.role}" data-field="role" data-row="${index}"></td>
                        <td><input type="checkbox" ${row.showCompany === true ? 'checked' : ''} data-field="showCompany" data-row="${index}" class="${row.showCompany !== undefined ? 'override-active' : 'global-default'}" title="${row.showCompany !== undefined ? 'Override: ' + (row.showCompany ? 'Show' : 'Hide') : 'Using global default'}"></td>
                        <td><input type="checkbox" ${row.showStage === true ? 'checked' : ''} data-field="showStage" data-row="${index}" class="${row.showStage !== undefined ? 'override-active' : 'global-default'}" title="${row.showStage !== undefined ? 'Override: ' + (row.showStage ? 'Show' : 'Hide') : 'Using global default'}"></td>
                        <td><input type="checkbox" ${row.showIncrease === true ? 'checked' : ''} data-field="showIncrease" data-row="${index}" class="${row.showIncrease !== undefined ? 'override-active' : 'global-default'}" title="${row.showIncrease !== undefined ? 'Override: ' + (row.showIncrease ? 'Show' : 'Hide') : 'Using global default'}"></td>
                        <td><input type="checkbox" ${row.showAmount === true ? 'checked' : ''} data-field="showAmount" data-row="${index}" class="${row.showAmount !== undefined ? 'override-active' : 'global-default'}" title="${row.showAmount !== undefined ? 'Override: ' + (row.showAmount ? 'Show' : 'Hide') : 'Using global default'}"></td>
                        <td><input type="checkbox" ${row.showRole === true ? 'checked' : ''} data-field="showRole" data-row="${index}" class="${row.showRole !== undefined ? 'override-active' : 'global-default'}" title="${row.showRole !== undefined ? 'Override: ' + (row.showRole ? 'Show' : 'Hide') : 'Using global default'}"></td>
                        <td>
                            <button class="toggle-hide-btn" data-row="${index}" style="padding: 4px 8px; background: ${row.hidden === 'true' || row.hidden === true ? '#999' : '#4CAF50'}; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 4px;">${row.hidden === 'true' || row.hidden === true ? '🚫' : '👁'}</button>
                            <button class="clear-overrides-btn" data-row="${index}" style="padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;" title="Clear per-row overrides">🔄</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    
                    // Add drag and drop event listeners
                    tr.addEventListener('dragstart', (e) => this.handleDragStart(e, index));
                    tr.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    tr.addEventListener('dragover', (e) => this.handleDragOver(e));
                    tr.addEventListener('drop', (e) => this.handleDrop(e, index));
                    tr.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    tr.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                });
                
                // Add toggle hide button listeners
                document.querySelectorAll('.toggle-hide-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rowIndex = parseInt(e.target.dataset.row);
                        const row = this.data[rowIndex];
                        row.hidden = row.hidden === 'true' || row.hidden === true ? 'false' : 'true';
                        this.populateDataTable();
                        this.renderAllWidgets();
                    });
                });

                // Add clear overrides button listeners
                document.querySelectorAll('.clear-overrides-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rowIndex = parseInt(e.target.dataset.row);
                        const row = this.data[rowIndex];
                        
                        // Remove per-row overrides - return to global defaults
                        delete row.showCompany;
                        delete row.showStage;
                        delete row.showIncrease;
                        delete row.showAmount;
                        delete row.showRole;
                        
                        this.populateDataTable();
                        this.renderAllWidgets();
                    });
                });

                // Add cell selection functionality
                if (!skipInit) {
                    this.setupCellSelection();
                    this.setupSorting();
                }
            }

            setupSorting() {
                // Only set up once - check if already initialized
                if (this.sortingInitialized) return;
                this.sortingInitialized = true;
                
                const sortableHeaders = document.querySelectorAll('.sortable');
                this.currentSort = { field: null, direction: 'asc' };

                sortableHeaders.forEach(header => {
                    // Remove any existing listeners first
                    const newHeader = header.cloneNode(true);
                    header.parentNode.replaceChild(newHeader, header);
                    
                    newHeader.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const field = newHeader.dataset.field;
                        
                        // Toggle sort direction
                        if (this.currentSort.field === field) {
                            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.currentSort.direction = 'asc';
                        }
                        this.currentSort.field = field;

                        // Update visual indicators
                        document.querySelectorAll('.sortable').forEach(h => {
                            h.classList.remove('sorted-asc', 'sorted-desc');
                        });
                        newHeader.classList.add(`sorted-${this.currentSort.direction}`);

                        // Sort the data
                        this.sortData(field, this.currentSort.direction);
                        this.populateDataTable(true); // Pass flag to skip re-initialization
                        this.renderAllWidgets();
                    });
                });
            }

            sortData(field, direction) {
                this.data.sort((a, b) => {
                    let aVal = a[field];
                    let bVal = b[field];

                    // Handle different data types
                    if (field === 'date') {
                        aVal = new Date(aVal || '1900-01-01');
                        bVal = new Date(bVal || '1900-01-01');
                    } else if (field === 'increase' || field === 'amount') {
                        // Remove commas and convert to numbers
                        aVal = parseFloat((aVal || '0').toString().replace(/,/g, ''));
                        bVal = parseFloat((bVal || '0').toString().replace(/,/g, ''));
                    } else {
                        // String comparison
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }

                    if (direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }

            setupCellSelection() {
                const table = document.getElementById('dataTable');
                const inputs = document.querySelectorAll('#dataTableBody input');
                
                // Clear existing event listeners
                inputs.forEach(input => {
                    input.replaceWith(input.cloneNode(true));
                });
                
                // Get fresh references after cloning
                const freshInputs = document.querySelectorAll('#dataTableBody input');
                
                freshInputs.forEach(input => {
                    // Click to select cells (but not for display option checkboxes)
                    input.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Don't interfere with display option checkboxes
                        if (e.target.type === 'checkbox' && e.target.dataset.field.startsWith('show')) {
                            return;
                        }
                        this.selectCell(e.target, e.ctrlKey || e.metaKey);
                    });

                    // Input changes
                    input.addEventListener('input', (e) => {
                        const row = parseInt(e.target.dataset.row);
                        const field = e.target.dataset.field;
                        
                        if (e.target.type === 'checkbox') {
                            this.data[row][field] = e.target.checked;
                        } else {
                            this.data[row][field] = e.target.value;
                        }
                        
                        // Re-render widgets when display options change
                        if (field.startsWith('show')) {
                            this.renderAllWidgets();
                        }
                    });

                    input.addEventListener('change', (e) => {
                        const row = parseInt(e.target.dataset.row);
                        const field = e.target.dataset.field;
                        
                        console.log('Change event:', field, e.target.checked, 'Row:', row);
                        
                        if (e.target.type === 'checkbox') {
                            this.data[row][field] = e.target.checked;
                            console.log('Updated data:', this.data[row]);
                        } else {
                            this.data[row][field] = e.target.value;
                        }
                        
                        // Re-render widgets when display options change
                        if (field.startsWith('show')) {
                            console.log('Re-rendering widgets due to display option change');
                            this.renderAllWidgets();
                        }
                    });

                    // Keyboard navigation
                    input.addEventListener('keydown', (e) => {
                        this.handleKeyNavigation(e);
                    });

                    // Paste handling
                    input.addEventListener('paste', (e) => {
                        e.preventDefault();
                        this.handlePaste(e);
                    });
                });

                // Table-level click to clear selection
                table.addEventListener('click', (e) => {
                    if (e.target === table || e.target.tagName === 'TD') {
                        this.clearSelection();
                    }
                });

                // Global keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'c':
                                e.preventDefault();
                                this.copySelectedCells();
                                break;
                            case 'v':
                                e.preventDefault();
                                this.pasteToSelectedCells();
                                break;
                            case 'a':
                                e.preventDefault();
                                this.selectAllCells();
                                break;
                        }
                    }
                });
            }

            selectCell(input, multiSelect = false) {
                if (!multiSelect) {
                    this.clearSelection();
                }
                
                input.classList.add('selected-cell');
                this.updateSelectedCells();
            }

            clearSelection() {
                document.querySelectorAll('.selected-cell, .selected-range').forEach(cell => {
                    cell.classList.remove('selected-cell', 'selected-range');
                });
                this.selectedCells = [];
            }

            selectAllCells() {
                this.clearSelection();
                const inputs = document.querySelectorAll('#dataTableBody input');
                inputs.forEach(input => {
                    input.classList.add('selected-cell');
                });
                this.updateSelectedCells();
            }

            handleKeyNavigation(e) {
                const currentInput = e.target;
                const currentRow = parseInt(currentInput.dataset.row);
                const currentField = currentInput.dataset.field;
                const fields = ['company', 'stage', 'increase', 'amount', 'department', 'role', 'showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'];
                const currentFieldIndex = fields.indexOf(currentField);
                
                let targetInput = null;
                
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentRow > 0) {
                            targetInput = document.querySelector(`input[data-row="${currentRow - 1}"][data-field="${currentField}"]`);
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentRow < this.data.length - 1) {
                            targetInput = document.querySelector(`input[data-row="${currentRow + 1}"][data-field="${currentField}"]`);
                        }
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        if (currentFieldIndex > 0) {
                            targetInput = document.querySelector(`input[data-row="${currentRow}"][data-field="${fields[currentFieldIndex - 1]}"]`);
                        }
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        if (currentFieldIndex < fields.length - 1) {
                            targetInput = document.querySelector(`input[data-row="${currentRow}"][data-field="${fields[currentFieldIndex + 1]}"]`);
                        }
                        break;
                    case 'Tab':
                        e.preventDefault();
                        if (e.shiftKey) {
                            // Shift+Tab: move left
                            if (currentFieldIndex > 0) {
                                targetInput = document.querySelector(`input[data-row="${currentRow}"][data-field="${fields[currentFieldIndex - 1]}"]`);
                            } else if (currentRow > 0) {
                                targetInput = document.querySelector(`input[data-row="${currentRow - 1}"][data-field="${fields[fields.length - 1]}"]`);
                            }
                        } else {
                            // Tab: move right
                            if (currentFieldIndex < fields.length - 1) {
                                targetInput = document.querySelector(`input[data-row="${currentRow}"][data-field="${fields[currentFieldIndex + 1]}"]`);
                            } else if (currentRow < this.data.length - 1) {
                                targetInput = document.querySelector(`input[data-row="${currentRow + 1}"][data-field="${fields[0]}"]`);
                            }
                        }
                        break;
                }
                
                if (targetInput) {
                    targetInput.focus();
                    targetInput.select();
                    this.selectCell(targetInput);
                }
            }

            handlePaste(e) {
                const clipboardData = e.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('text');
                
                if (pastedData) {
                    this.pasteBulkData(pastedData, e.target);
                }
            }

            pasteBulkData(data, startInput) {
                const rows = data.split('\n').filter(row => row.trim());
                const startRow = parseInt(startInput.dataset.row);
                const startField = startInput.dataset.field;
                const fields = ['company', 'stage', 'increase', 'amount', 'department', 'role', 'showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'];
                const startFieldIndex = fields.indexOf(startField);
                
                rows.forEach((row, rowIndex) => {
                    const cells = row.split('\t');
                    
                    cells.forEach((cell, cellIndex) => {
                        const targetRow = startRow + rowIndex;
                        const targetFieldIndex = startFieldIndex + cellIndex;
                        
                        if (targetRow < this.data.length && targetFieldIndex < fields.length) {
                            const targetField = fields[targetFieldIndex];
                            const targetInput = document.querySelector(`input[data-row="${targetRow}"][data-field="${targetField}"]`);
                            
                            if (targetInput) {
                                if (targetInput.type === 'checkbox') {
                                    targetInput.checked = cell.toLowerCase() === 'true' || cell === '1';
                                } else {
                                    targetInput.value = cell;
                                }
                                
                                // Update data
                                this.data[targetRow][targetField] = targetInput.type === 'checkbox' ? targetInput.checked : cell;
                                
                                // Select the pasted cell
                                targetInput.classList.add('selected-cell');
                            }
                        }
                    });
                });
                
                this.updateSelectedCells();
                this.renderAllWidgets();
                
                // Show paste indicator
                this.showPasteIndicator(startInput, `${rows.length} rows pasted`);
            }

            showPasteIndicator(input, message) {
                const indicator = document.createElement('div');
                indicator.className = 'paste-indicator';
                indicator.textContent = message;
                
                const rect = input.getBoundingClientRect();
                indicator.style.left = rect.right + 10 + 'px';
                indicator.style.top = rect.top + 'px';
                
                document.body.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.remove();
                }, 2000);
            }

            updateSelectedCells() {
                this.selectedCells = Array.from(document.querySelectorAll('.selected-cell'));
            }

            addDataRow() {
                const newRow = {
                    company: "New Company",
                    stage: "Series A",
                    increase: "0.00",
                    amount: "0",
                    department: "Department",
                    role: "Role",
                    showCompany: false,
                    showStage: true,
                    showIncrease: false,
                    showAmount: true,
                    showRole: true
                };
                this.data.push(newRow);
                this.populateDataTable();
            }

            deleteSelectedRows() {
                const selectedRows = new Set();
                this.selectedCells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    selectedRows.add(row);
                });

                // Sort in descending order to avoid index issues
                const sortedRows = Array.from(selectedRows).sort((a, b) => b - a);
                sortedRows.forEach(rowIndex => {
                    this.data.splice(rowIndex, 1);
                });

                this.populateDataTable();
                this.renderAllWidgets();
            }
            
            deleteRow(rowIndex) {
                this.data.splice(rowIndex, 1);
                this.populateDataTable();
                this.renderAllWidgets();
            }
            
            hideSelectedRows() {
                const selectedRows = new Set();
                this.selectedCells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    selectedRows.add(row);
                });
                
                selectedRows.forEach(rowIndex => {
                    this.data[rowIndex].hidden = 'true';
                });
                
                this.populateDataTable();
                this.renderAllWidgets();
            }
            
            toggleShowHidden() {
                this.showHidden = !this.showHidden;
                const btn = document.getElementById('showHiddenBtn');
                btn.textContent = this.showHidden ? '🚫 Hide Hidden' : '👁 Show Hidden';
                this.populateDataTable();
                this.renderAllWidgets();
            }
            
            async loadDataFromCSV() {
                // Always load fresh from CSV data each session
                console.log('Loading data from CSV...');
                
                // For local file:// protocol, show file input
                if (window.location.protocol === 'file:') {
                    console.log('Local file detected, please select the CSV file');
                    this.promptForCSVFile();
                    return;
                }
                
                try {
                    // Try to fetch CSV file (for web server)
                    const response = await fetch('negotiation-wins-data.csv');
                    if (!response.ok) throw new Error('CSV not found');
                    
                    const csvText = await response.text();
                    this.parseCSVData(csvText);
                    this.renderAllWidgets();
                    console.log('Loaded', this.data.length, 'rows from CSV');
                } catch (error) {
                    console.error('CSV file not accessible:', error);
                    this.promptForCSVFile();
                }
            }

            promptForCSVFile() {
                // Trigger the file input to allow user to select a CSV file
                const fileInput = document.getElementById('importFile');
                if (fileInput) {
                    // Set accept to only CSV files for this specific prompt
                    fileInput.accept = '.csv';
                    fileInput.click();
                } else {
                    console.error('File input element not found');
                    alert('File input not available. Please use the Import button instead.');
                }
            }
            
            
            saveDataToCSV() {
                // Generate CSV content with all columns including display overrides
                const headers = ['date', 'company', 'stage', 'increase', 'amount', 'department', 'role', 'hidden', 'showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'];
                let csvContent = headers.join(',') + '\n';
                
                this.data.forEach(row => {
                    const csvRow = headers.map(header => {
                        let value = row[header];
                        
                        // Handle undefined/null values
                        if (value === undefined || value === null) {
                            value = '';
                        }
                        
                        // Convert booleans to strings
                        if (typeof value === 'boolean') {
                            value = value.toString();
                        }
                        
                        // Escape commas and quotes in CSV
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        }
                        
                        return value;
                    });
                    csvContent += csvRow.join(',') + '\n';
                });
                
                // Create a file input to let user choose save location
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.style.display = 'none';
                
                // Create a temporary link to trigger download
                const filename = 'negotiation-wins-data.csv';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                
                // Show a dialog asking where to save
                const saveLocation = confirm(`💾 Save CSV File\n\n📊 Records: ${this.data.length}\n📁 Filename: ${filename}\n\nClick OK to save to Downloads folder, or Cancel to copy data to clipboard instead.`);
                
                if (saveLocation) {
                    // User chose to save to Downloads
                a.click();
                URL.revokeObjectURL(url);
                
                    const message = `✅ CSV file saved to Downloads folder!\n\n📁 File: ${filename}\n📊 Records: ${this.data.length}\n\n🔄 TO UPDATE YOUR ORIGINAL FILE:\n\n1. Open your project folder\n2. Go to Downloads folder\n3. Find: ${filename}\n4. Drag it to your project folder\n5. Choose "Replace" when prompted\n\n✅ Your original CSV will be updated!`;
                    alert(message);
                } else {
                    // User chose to copy to clipboard instead
                    navigator.clipboard.writeText(csvContent).then(() => {
                        alert(`📋 CSV data copied to clipboard!\n\n📊 Records: ${this.data.length}\n\n💡 You can now paste it into a text editor and save it wherever you want.`);
                    }).catch(() => {
                        // Fallback if clipboard fails
                        a.click();
                        URL.revokeObjectURL(url);
                        alert(`✅ CSV file saved to Downloads folder!\n\n📁 File: ${filename}\n📊 Records: ${this.data.length}`);
                    });
                }
                
                // Also log to console for easy copy-paste
                console.log('=== CSV DATA SAVED ===');
                console.log(`Filename: ${filename}`);
                console.log(`Records: ${this.data.length}`);
                console.log('CSV Content:');
                console.log(csvContent);
                console.log('=====================');
            }

            applyBulkRules() {
                // Apply bulk changes to the data
                console.log('Applying bulk rules...');
                
                this.data.forEach(row => {
                    // Rule 1: If showIncrease and showAmount are both false, then hidden = true
                    if (row.showIncrease === false && row.showAmount === false) {
                        row.hidden = true;
                        console.log(`Hiding ${row.company} - both show values are false`);
                    }
                    
                    // Rule 2: Set showIncrease = true ONLY if showAmount is false
                    if (row.showAmount === false) {
                        row.showIncrease = true;
                        console.log(`Setting showIncrease = true for ${row.company} (showAmount is false)`);
                    } else {
                        row.showIncrease = false;
                        console.log(`Setting showIncrease = false for ${row.company} (showAmount is true)`);
                    }
                });
                
                // Rule 3: Sort by date descending
                this.data.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA; // Descending order (newest first)
                });
                
                console.log('Bulk rules applied successfully!');
                console.log('Data sorted by date (newest first)');
                
                // Update the display
                this.populateDataTable();
                this.renderAllWidgets();
                
                alert(`✅ Bulk rules applied successfully!\n\n📋 Changes made:\n• Hidden items where both show values were false\n• Set show % = true only where show $ = false\n• Sorted by date (newest first)\n\n💾 Click "Export CSV" to save changes to file.`);
            }
            

            copySelectedCells() {
                const selectedInputs = document.querySelectorAll('#dataTableBody .selected-cell input');
                if (selectedInputs.length === 0) {
                    alert('Please select cells first');
                    return;
                }
                
                // Store both internal clipboard and system clipboard
                this.clipboard = [];
                let clipboardText = '';
                
                selectedInputs.forEach((input, index) => {
                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    this.clipboard.push({
                        value: value,
                        row: parseInt(input.dataset.row),
                        field: input.dataset.field,
                        type: input.type
                    });
                    
                    // For system clipboard, use tab-separated values
                    if (index > 0) clipboardText += '\t';
                    clipboardText += value;
                });
                
                // Copy to system clipboard
                navigator.clipboard.writeText(clipboardText).catch(err => {
                    console.log('Could not copy to clipboard:', err);
                });
                
                console.log(`Copied ${selectedInputs.length} cells to clipboard`);
            }

            async pasteToSelectedCells() {
                try {
                    // Try to get data from system clipboard first
                    const clipboardText = await navigator.clipboard.readText();
                    
                    if (clipboardText && clipboardText.trim()) {
                        this.pasteFromClipboardText(clipboardText);
                    } else if (this.clipboard && this.clipboard.length > 0) {
                        this.pasteFromInternalClipboard();
                    } else {
                        alert('No data to paste');
                    }
                } catch (err) {
                    console.log('Could not access clipboard, using internal clipboard:', err);
                    if (this.clipboard && this.clipboard.length > 0) {
                        this.pasteFromInternalClipboard();
                    } else {
                        alert('No data to paste');
                    }
                }
            }
            
            pasteFromClipboardText(text) {
                const selectedInputs = document.querySelectorAll('#dataTableBody .selected-cell input');
                if (selectedInputs.length === 0) {
                    alert('Please select cells first');
                    return;
                }
                
                // Parse clipboard text (handle both tab and comma separated)
                const lines = text.split('\n').filter(line => line.trim());
                const allValues = [];
                
                lines.forEach(line => {
                    // Try tab-separated first, then comma-separated
                    const values = line.includes('\t') ? line.split('\t') : line.split(',');
                    allValues.push(...values.map(v => v.trim()));
                });
                
                // Apply values to selected cells
                selectedInputs.forEach((input, index) => {
                    if (index < allValues.length) {
                        const value = allValues[index];
                        
                        if (input.type === 'checkbox') {
                            input.checked = value === 'true' || value === '1' || value.toLowerCase() === 'yes';
                        } else {
                            input.value = value;
                        }
                        
                        // Update data array
                        const row = parseInt(input.dataset.row);
                        const field = input.dataset.field;
                        if (this.data[row] && field) {
                            if (input.type === 'checkbox') {
                                this.data[row][field] = input.checked;
                            } else {
                                this.data[row][field] = value;
                            }
                        }
                    }
                });
                
                this.renderAllWidgets();
                console.log(`Pasted data to ${Math.min(selectedInputs.length, allValues.length)} cells`);
            }
            
            pasteFromInternalClipboard() {
                const selectedInputs = document.querySelectorAll('#dataTableBody .selected-cell input');
                if (selectedInputs.length === 0) {
                    alert('Please select cells first');
                    return;
                }
                
                selectedInputs.forEach((input, index) => {
                    if (index < this.clipboard.length) {
                        const clipboardItem = this.clipboard[index];
                        
                        if (input.type === 'checkbox' && typeof clipboardItem.value === 'boolean') {
                            input.checked = clipboardItem.value;
                        } else {
                            input.value = clipboardItem.value;
                        }
                        
                        // Update data array
                        const row = parseInt(input.dataset.row);
                        const field = input.dataset.field;
                        if (this.data[row] && field) {
                            if (input.type === 'checkbox') {
                                this.data[row][field] = input.checked;
                            } else {
                                this.data[row][field] = input.value;
                            }
                        }
                    }
                });
                
                this.renderAllWidgets();
                console.log(`Pasted internal clipboard data to ${Math.min(selectedInputs.length, this.clipboard.length)} cells`);
            }

            saveDataChanges() {
                // Capture all changes from the table inputs and update the data array
                const inputs = document.querySelectorAll('#dataTableBody input');
                
                inputs.forEach(input => {
                    const rowIndex = parseInt(input.dataset.row);
                    const field = input.dataset.field;
                    
                    if (this.data[rowIndex] && field) {
                        if (input.type === 'checkbox') {
                            // Handle display override checkboxes
                            if (field.startsWith('show')) {
                                if (input.checked) {
                                    this.data[rowIndex][field] = true;
                                } else {
                                    this.data[rowIndex][field] = false;
                                }
                            }
                        } else {
                            // Handle text and date inputs
                            this.data[rowIndex][field] = input.value;
                        }
                    }
                });
                
                console.log('Data after save:', this.data);
                
                this.updateWidgetData();
                this.closeDataEditor();
                alert('Data saved successfully!');
            }
            
            showSelectedRows() {
                const selectedRows = this.getSelectedRows();
                if (selectedRows.length === 0) {
                    alert('Please select rows first');
                    return;
                }
                
                selectedRows.forEach(rowIndex => {
                    this.data[rowIndex].hidden = 'false';
                });
                
                this.populateDataTable();
                this.renderAllWidgets();
            }
            
            bulkEditSelected(field, value) {
                const selectedRows = this.getSelectedRows();
                if (selectedRows.length === 0) {
                    alert('Please select rows first');
                    return;
                }
                
                selectedRows.forEach(rowIndex => {
                    this.data[rowIndex][field] = value;
                });
                
                this.populateDataTable();
                this.renderAllWidgets();
                alert(`Updated ${field} for ${selectedRows.length} rows`);
            }
            
            bulkClearOverrides() {
                const selectedRows = this.getSelectedRows();
                if (selectedRows.length === 0) {
                    alert('Please select rows first');
                    return;
                }
                
                selectedRows.forEach(rowIndex => {
                    const row = this.data[rowIndex];
                    delete row.showCompany;
                    delete row.showStage;
                    delete row.showIncrease;
                    delete row.showAmount;
                    delete row.showRole;
                });
                
                this.populateDataTable();
                this.renderAllWidgets();
                alert(`Cleared overrides for ${selectedRows.length} rows`);
            }
            
            getSelectedRows() {
                const selectedRows = [];
                const checkboxes = document.querySelectorAll('#dataTableBody tr input[type="checkbox"]:checked');
                const selectedCells = document.querySelectorAll('.selected-cell');
                
                // Get rows from selected checkboxes (if any)
                checkboxes.forEach(checkbox => {
                    const rowIndex = parseInt(checkbox.dataset.row);
                    if (!selectedRows.includes(rowIndex)) {
                        selectedRows.push(rowIndex);
                    }
                });
                
                // Get rows from selected cells (if no checkboxes selected)
                if (selectedRows.length === 0) {
                    selectedCells.forEach(cell => {
                        const input = cell.querySelector('input');
                        if (input && input.dataset.row) {
                            const rowIndex = parseInt(input.dataset.row);
                            if (!selectedRows.includes(rowIndex)) {
                                selectedRows.push(rowIndex);
                            }
                        }
                    });
                }
                
                return selectedRows;
            }

            updateWidgetData() {
                // Update the actual widget display with new data
                this.renderAllWidgets();
            }

            renderWidget() {
                // Update the actual widget display
                this.renderAllWidgets();
            }

            

            
            getStaticCardHTML() {
                const html = this.generateCardHTML();
                return `<div class="infinite-scroll-wrapper">
    <div class="infinite-scroll-track" style="animation-duration: ${document.getElementById('speedInput').value}s;">
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
    </div>
</div>`;
            }
            
            getStaticPillHTML() {
                const html = this.generatePillHTML();
                return `<div class="infinite-scroll-wrapper">
    <div class="infinite-scroll-track" style="animation-duration: ${document.getElementById('speedInput').value}s;">
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
    </div>
</div>`;
            }
            
            getStaticBannerHTML() {
                const html = this.generateBannerHTML();
                return `<div class="infinite-scroll-wrapper">
    <div class="infinite-scroll-track" style="animation-duration: ${document.getElementById('speedInput').value}s;">
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
        <div class="infinite-scroll-content">${html}</div>
    </div>
</div>`;
            }
            
            getStaticWidgetCSS() {
                // Return complete CSS for static widgets (SEO-friendly, no JS needed)
                const currentVars = getComputedStyle(document.documentElement);
                const speed = document.getElementById('speedInput').value;
                return `
/* Negotiation Wins Widget - Static CSS */
.infinite-scroll-wrapper {
    width: 100%;
    overflow: hidden;
    position: relative;
    margin: 40px 0;
}

.infinite-scroll-wrapper::before,
.infinite-scroll-wrapper::after {
    content: '';
    position: absolute;
    top: 0;
    width: 100px;
    height: 100%;
    z-index: 2;
    pointer-events: none;
}

.infinite-scroll-wrapper::before {
    left: 0;
    background: linear-gradient(90deg, white 0%, transparent 100%);
}

.infinite-scroll-wrapper::after {
    right: 0;
    background: linear-gradient(90deg, transparent 0%, white 100%);
}

.infinite-scroll-track {
    display: flex;
    width: fit-content;
    animation: scroll ${speed}s linear infinite;
}

.infinite-scroll-content {
    display: flex;
    gap: 20px;
    padding: 10px;
    flex-shrink: 0;
}

@keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-33.3333%); }
}

.infinite-scroll-wrapper:hover .infinite-scroll-track {
    animation-play-state: paused;
}

/* Card Styles */
.win-card {
    min-width: 320px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border: 2px solid rgba(94, 90, 219, 0.1);
}

.win-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: #5E5ADB;
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    padding: 12px;
}

.card-icon svg {
    width: 100%;
    height: 100%;
    color: white;
}

.card-company {
    font-size: 1.125rem;
    font-weight: 600;
    color: #6C757D;
    margin-bottom: 8px;
}

.card-stage {
    font-size: 0.875rem;
    color: #5E5ADB;
    font-weight: 500;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.card-amount {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
}

.card-increase {
    font-size: 1.75rem;
    font-weight: 700;
    color: #4ECDC4;
    margin-bottom: 8px;
}

.card-increase.secondary,
.card-amount.secondary {
    font-size: 1.125rem;
    color: #6C757D;
    font-weight: 600;
    margin-bottom: 12px;
}

.card-details {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.card-badge {
    padding: 4px 12px;
    background: #F8F9FA;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6C757D;
}

/* Pill Styles */
.win-pill {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    background: white;
    border-radius: 50px;
    box-shadow: var(--shadow-sm);
    min-width: fit-content;
    transition: all 0.3s ease;
    border: 2px solid #F8F9FA;
}

.win-pill:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
    border-color: #5E5ADB;
}

.pill-logo {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
}

.pill-logo svg {
    width: 100%;
    height: 100%;
    color: white;
}

.pill-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.pill-company {
    font-weight: 600;
    font-size: 1rem;
    color: #1A1A2E;
}

.pill-stage {
    font-size: 0.75rem;
    color: #5E5ADB;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.pill-stats {
    display: flex;
    gap: 12px;
    align-items: center;
}

.pill-amount,
.pill-increase {
    font-weight: 700;
    font-size: 0.875rem;
}

.pill-amount {
    color: #5E5ADB;
}

.pill-increase {
    color: #4ECDC4;
}

.pill-role {
    font-size: 0.75rem;
    color: #6C757D;
}

/* Banner Styles */
.win-banner {
    min-width: 500px;
    padding: 32px;
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    border: 2px solid #F8F9FA;
    transition: all 0.3s ease;
}

.win-banner:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
    border-color: #5E5ADB;
}

.banner-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 20px;
}

.banner-company {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1A1A2E;
}

.banner-stage {
    font-size: 0.875rem;
    color: #5E5ADB;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
}

.banner-role {
    font-size: 0.875rem;
    color: #6C757D;
    margin-top: 4px;
}

.banner-increase-group {
    text-align: right;
}

.banner-amount,
.banner-increase {
    font-size: 2rem;
    font-weight: 700;
}

.banner-amount {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.banner-increase {
    color: #4ECDC4;
}

.banner-increase-label {
    font-size: 0.75rem;
    color: #6C757D;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
}

.banner-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    border-top: 1px solid #F8F9FA;
}

.banner-seniority {
    font-size: 0.875rem;
    color: #6C757D;
    font-weight: 500;
}
                `.trim();
            }
            
            getWidgetCSS() {
                // Return essential CSS for the widgets
                const currentVars = getComputedStyle(document.documentElement);
                return `
/* Widget Variables */
:root {
    --primary-color: ${currentVars.getPropertyValue('--primary-color')};
    --secondary-color: ${currentVars.getPropertyValue('--secondary-color')};
    --success-color: ${currentVars.getPropertyValue('--success-color')};
    --accent-color: ${currentVars.getPropertyValue('--accent-color')};
    --text-primary: ${currentVars.getPropertyValue('--text-primary')};
    --text-secondary: ${currentVars.getPropertyValue('--text-secondary')};
    --bg-light: ${currentVars.getPropertyValue('--bg-light')};
    --bg-white: ${currentVars.getPropertyValue('--bg-white')};
    --font-family: ${currentVars.getPropertyValue('--font-family')};
    --base-font-size: ${currentVars.getPropertyValue('--base-font-size')};
    --card-padding: ${currentVars.getPropertyValue('--card-padding')};
    --card-gap: ${currentVars.getPropertyValue('--card-gap')};
    --border-radius: ${currentVars.getPropertyValue('--border-radius')};
    --animation-duration: ${currentVars.getPropertyValue('--animation-duration')};
}

/* Infinite Scroll Container */
.infinite-scroll-wrapper {
    width: 100%;
    overflow: hidden;
    position: relative;
    margin: 40px 0;
}

.infinite-scroll-track {
    display: flex;
    animation: scroll var(--animation-duration) linear infinite;
}

.infinite-scroll-content {
    display: flex;
    gap: var(--card-gap);
    padding: 10px;
    min-width: fit-content;
}

@keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

.infinite-scroll-wrapper:hover .infinite-scroll-track {
    animation-play-state: paused;
}

/* Card Styles */
.win-card {
    min-width: 320px;
    padding: var(--card-padding);
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    padding: 12px;
}

.card-icon svg {
    width: 100%;
    height: 100%;
    color: white;
}

/* Pill Styles */
.win-pill {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    background: var(--bg-white);
    border-radius: 50px;
    box-shadow: var(--shadow-sm);
    min-width: fit-content;
}

.pill-logo {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
}

.pill-logo svg {
    width: 100%;
    height: 100%;
    color: white;
}

/* Banner Styles */
.win-banner {
    min-width: 500px;
    padding: 32px;
    background: var(--bg-white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
}
                `.trim();
            }
            
            getCardWidgetHTML() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[0];
                if (wrapper) {
                    return wrapper.outerHTML;
                }
                return '';
            }
            
            getPillWidgetHTML() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[1];
                if (wrapper) {
                    return wrapper.outerHTML;
                }
                return '';
            }
            
            getBannerWidgetHTML() {
                const wrapper = document.querySelectorAll('.infinite-scroll-wrapper')[2];
                if (wrapper) {
                    return wrapper.outerHTML;
                }
                return '';
            }
            
            exportData() {
                // Use the improved saveDataToCSV method for consistency
                this.saveDataToCSV();
            }

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        
                        // Check if it's JSON or CSV
                        if (file.name.toLowerCase().endsWith('.json')) {
                            // Handle JSON import
                            const importedData = JSON.parse(content);
                            if (Array.isArray(importedData)) {
                                this.data = importedData;
                                this.populateDataTable();
                                this.renderAllWidgets();
                                alert('JSON data imported successfully!');
                            } else {
                                alert('Invalid JSON data format');
                            }
                        } else if (file.name.toLowerCase().endsWith('.csv')) {
                            // Handle CSV import
                            const lines = content.split('\n').filter(line => line.trim());
                            if (lines.length < 2) {
                                alert('CSV file must have headers and at least one data row');
                                return;
                            }
                            
                            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                            const expectedHeaders = ['date', 'company', 'stage', 'increase', 'amount', 'department', 'role', 'hidden', 'showCompany', 'showStage', 'showIncrease', 'showAmount', 'showRole'];
                            
                            // Parse CSV data
                            const importedData = [];
                            for (let i = 1; i < lines.length; i++) {
                                const values = this.parseCSVLine(lines[i]);
                                if (values.length >= 7) { // At least the basic required fields
                                    const row = {};
                                    
                                    // Map each value to its header
                                    headers.forEach((header, index) => {
                                        let value = values[index] || '';
                                        
                                        // Convert boolean strings back to booleans
                                        if (header.startsWith('show') || header === 'hidden') {
                                            if (value === 'true') value = true;
                                            else if (value === 'false') value = false;
                                            else if (value === '') value = undefined;
                                        }
                                        
                                        // Convert numeric values
                                        if (header === 'increase' || header === 'amount') {
                                            value = parseFloat(value) || 0;
                                        }
                                        
                                        row[header] = value;
                                    });
                                    
                                    // Ensure all expected headers exist with defaults
                                    expectedHeaders.forEach(header => {
                                        if (row[header] === undefined) {
                                            if (header.startsWith('show')) {
                                                row[header] = true; // Default to showing all fields
                                            } else if (header === 'hidden') {
                                                row[header] = false; // Default to not hidden
                                            } else {
                                                row[header] = '';
                                            }
                                        }
                                    });
                                    
                                    // Ensure hidden field is properly set as boolean
                                    if (typeof row.hidden === 'string') {
                                        row.hidden = row.hidden === 'true';
                                    }
                                    
                                    importedData.push(row);
                                }
                            }
                            
                            if (importedData.length > 0) {
                                this.data = importedData;
                                const hiddenCount = importedData.filter(row => row.hidden === true).length;
                                this.populateDataTable();
                                this.renderAllWidgets();
                                const message = `CSV data imported successfully! ${importedData.length} records loaded.${hiddenCount > 0 ? `\n\nFound ${hiddenCount} hidden items.` : ''}`;
                                alert(message);
                            } else {
                                alert('No valid data found in CSV file');
                            }
                        } else {
                            alert('Please select a .json or .csv file');
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
            
            parseCSVLine(line) {
                // Simple CSV parser that handles quoted fields
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes) {
                        inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // Add the last value
                values.push(current.trim());
                
                return values;
            }

            changeTheme(theme) {
                const root = document.documentElement;
                
                // Set Montserrat font for all themes
                root.style.setProperty('--font-family', "'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif");
                
                if (theme === 'light') {
                    // Light Theme - Clean and professional
                    root.style.setProperty('--bg-white', '#ffffff');
                    root.style.setProperty('--bg-light', '#f7f8fc');
                    root.style.setProperty('--text-primary', '#2d3748');
                    root.style.setProperty('--text-secondary', '#718096');
                    root.style.setProperty('--primary-color', '#667eea');
                    root.style.setProperty('--secondary-color', '#764ba2');
                    root.style.setProperty('--success-color', '#48bb78');
                    root.style.setProperty('--accent-color', '#ed64a6');
                    root.style.setProperty('--shadow-sm', '0 2px 8px rgba(102, 126, 234, 0.15)');
                    root.style.setProperty('--shadow-md', '0 8px 25px rgba(102, 126, 234, 0.2)');
                    root.style.setProperty('--shadow-lg', '0 15px 35px rgba(102, 126, 234, 0.25)');
                } else if (theme === 'dark') {
                    // Dark Theme - Modern and sophisticated
                    root.style.setProperty('--bg-white', '#1a202c');
                    root.style.setProperty('--bg-light', '#2d3748');
                    root.style.setProperty('--text-primary', '#f7fafc');
                    root.style.setProperty('--text-secondary', '#cbd5e0');
                    root.style.setProperty('--primary-color', '#9f7aea');
                    root.style.setProperty('--secondary-color', '#68d391');
                    root.style.setProperty('--success-color', '#4fd1c7');
                    root.style.setProperty('--accent-color', '#f687b3');
                    root.style.setProperty('--shadow-sm', '0 2px 8px rgba(159, 122, 234, 0.3)');
                    root.style.setProperty('--shadow-md', '0 8px 25px rgba(159, 122, 234, 0.4)');
                    root.style.setProperty('--shadow-lg', '0 15px 35px rgba(159, 122, 234, 0.5)');
                } else if (theme === 'ocean') {
                    // Ocean Theme - Professional blues
                    root.style.setProperty('--bg-white', '#f0f9ff');
                    root.style.setProperty('--bg-light', '#e0f2fe');
                    root.style.setProperty('--text-primary', '#0c4a6e');
                    root.style.setProperty('--text-secondary', '#0369a1');
                    root.style.setProperty('--primary-color', '#0ea5e9');
                    root.style.setProperty('--secondary-color', '#06b6d4');
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--accent-color', '#8b5cf6');
                    root.style.setProperty('--shadow-sm', '0 2px 8px rgba(14, 165, 233, 0.15)');
                    root.style.setProperty('--shadow-md', '0 8px 25px rgba(14, 165, 233, 0.2)');
                    root.style.setProperty('--shadow-lg', '0 15px 35px rgba(14, 165, 233, 0.25)');
                } else if (theme === 'sunset') {
                    // Sunset Theme - Warm and inviting
                    root.style.setProperty('--bg-white', '#fffbeb');
                    root.style.setProperty('--bg-light', '#fef3c7');
                    root.style.setProperty('--text-primary', '#92400e');
                    root.style.setProperty('--text-secondary', '#d97706');
                    root.style.setProperty('--primary-color', '#f59e0b');
                    root.style.setProperty('--secondary-color', '#ef4444');
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--accent-color', '#8b5cf6');
                    root.style.setProperty('--shadow-sm', '0 2px 8px rgba(245, 158, 11, 0.15)');
                    root.style.setProperty('--shadow-md', '0 8px 25px rgba(245, 158, 11, 0.2)');
                    root.style.setProperty('--shadow-lg', '0 15px 35px rgba(245, 158, 11, 0.25)');
                } else if (theme === 'forest') {
                    // Forest Theme - Natural and calming
                    root.style.setProperty('--bg-white', '#f0fdf4');
                    root.style.setProperty('--bg-light', '#dcfce7');
                    root.style.setProperty('--text-primary', '#14532d');
                    root.style.setProperty('--text-secondary', '#166534');
                    root.style.setProperty('--primary-color', '#22c55e');
                    root.style.setProperty('--secondary-color', '#84cc16');
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--accent-color', '#f59e0b');
                    root.style.setProperty('--shadow-sm', '0 2px 8px rgba(34, 197, 94, 0.15)');
                    root.style.setProperty('--shadow-md', '0 8px 25px rgba(34, 197, 94, 0.2)');
                    root.style.setProperty('--shadow-lg', '0 15px 35px rgba(34, 197, 94, 0.25)');
                }
                // Update gradients based on theme colors
                this.updateGradients();
                // Re-render widgets to apply new theme
                this.renderAllWidgets();
            }
            
            updateGradients() {
                const root = document.documentElement;
                const primary = getComputedStyle(root).getPropertyValue('--primary-color');
                const secondary = getComputedStyle(root).getPropertyValue('--secondary-color');
                const success = getComputedStyle(root).getPropertyValue('--success-color');
                const accent = getComputedStyle(root).getPropertyValue('--accent-color');
                
                root.style.setProperty('--gradient-1', `linear-gradient(135deg, ${primary} 0%, ${accent} 100%)`);
                root.style.setProperty('--gradient-2', `linear-gradient(135deg, ${secondary} 0%, ${primary} 100%)`);
                root.style.setProperty('--gradient-3', `linear-gradient(135deg, ${success} 0%, ${primary} 100%)`);
                root.style.setProperty('--gradient-4', `linear-gradient(135deg, ${accent} 0%, ${secondary} 100%)`);
            }
        }

        // Initialize the widget when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const widget = new NegotiationWidget();
            // Initialize gradients based on current theme
            widget.updateGradients();
        });
    </script>
</body>
</html>
